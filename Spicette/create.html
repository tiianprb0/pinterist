<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buat Pin Baru - Spicette</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: linear-gradient(135deg, #f9f9f9, #e0e0e0);
            color: #333;
            overscroll-behavior: none;
            margin: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        main {
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .back-button-container {
            margin-bottom: 20px;
            align-self: flex-start;
        }

        .back-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .back-button .fas {
            font-size: 20px;
            color: #111;
        }

        .create-pin-form {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .create-pin-form h2 {
            font-family: 'Playfair Display', serif;
            font-size: 28px;
            color: #111;
            margin-bottom: 20px;
            font-weight: 700;
            text-align: left;
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
            position: relative;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            color: #333;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
            color: #333;
            transition: border-color 0.2s ease, background 0.2s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            touch-action: manipulation;
        }

        .form-group select:not([multiple]) {
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="6" viewBox="0 0 24 24" fill="%23333"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 30px;
        }

        .form-group select[multiple] {
            min-height: 120px;
            overflow-y: auto;
            padding: 5px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: #e60023;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .create-pin-form button {
            background: linear-gradient(135deg, #e60023, #ad081b);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 24px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .create-pin-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .create-pin-form button:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            transform: none;
        }

        .loading-spinner {
            display: none;
            border: 3px solid #fff;
            border-top: 3px solid #e60023;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
        }

        .create-pin-form button:disabled .loading-spinner {
            display: inline-block;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .radio-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s ease, color 0.2s ease;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .radio-group:hover {
            transform: scale(1.02);
        }

        .radio-group:hover label {
            color: #e60023;
        }

        .radio-group input[type="radio"] {
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            position: relative;
            margin-right: 5px;
            background: rgba(255, 255, 255, 0.1);
        }

        .radio-group input[type="radio"]:checked {
            border-color: #e60023;
            background: #e60023;
        }

        .radio-group input[type="radio"]:checked::after {
            content: '';
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .radio-group label {
            font-size: 14px;
            color: #333;
            font-weight: normal;
            cursor: pointer;
        }

        .form-group-inline {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: 10px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .form-group-inline label {
            font-size: 13px;
            color: #555;
        }

        .form-group-inline textarea {
            font-size: 14px;
        }

        .recommend-button {
            background: linear-gradient(135deg, #ff6b6b, #e60023);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 16px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 10px;
            display: inline-block;
        }

        .recommend-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .recommend-button:disabled {
            background: rgba(255, 255, 255, 0.2);
            cursor: not-allowed;
            transform: none;
        }

        .title-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .title-suggestion {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 8px 16px;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: background 0.2s ease, transform 0.2s ease;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .title-suggestion:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .person-tag-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-height: 150px;
            overflow-y: auto;
            display: none;
            list-style: none;
            padding: 0;
            margin: 5px 0 0 0;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .person-tag-suggestions li {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            transition: background 0.2s ease;
        }

        .person-tag-suggestions li:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .person-tag-suggestions li.selected {
            background: #e60023;
            color: white;
        }

        .custom-alert {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            white-space: nowrap;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .custom-alert.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        .custom-alert.success {
            background: rgba(40, 167, 69, 0.7);
        }

        .custom-alert.error {
            background: rgba(220, 53, 69, 0.7);
        }

        @media (max-width: 768px) {
            main {
                margin: 20px 10px;
                padding: 15px;
            }

            .create-pin-form h2 {
                font-size: 24px;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 16px;
                padding: 10px;
            }

            .create-pin-form button,
            .recommend-button {
                font-size: 14px;
                padding: 10px;
            }

            .back-button {
                width: 36px;
                height: 36px;
            }

            .back-button .fas {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .form-group label {
                font-size: 13px;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 16px;
            }

            .radio-group input[type="radio"] {
                width: 18px;
                height: 18px;
            }

            .radio-group input[type="radio"]:checked::after {
                width: 8px;
                height: 8px;
            }

            .title-suggestion {
                font-size: 13px;
                padding: 6px 12px;
            }
        }

        .access-denied-message {
            text-align: center;
            font-size: 18px;
            color: #e60023;
            margin-top: 50px;
            display: none;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
    </style>
</head>
<body>
    <main>
        <div class="back-button-container">
            <button class="back-button" onclick="window.location.href='index.html'" aria-label="Kembali">
                <i class="fas fa-arrow-left"></i>
            </button>
        </div>
        <form id="createPinForm" class="create-pin-form" enctype="multipart/form-data">
            <h2>Buat Pin Baru</h2>
            <div id="createMessage" class="custom-alert"></div>
            <div class="form-group">
                <label for="title">Judul Pin:</label>
                <input type="text" id="title" name="title" placeholder="Masukkan judul pin" required>
                <button type="button" id="recommendTitleButton" class="recommend-button">Rekomendasikan Judul</button>
                <div id="titleSuggestions" class="title-suggestions"></div>
            </div>
            <div class="form-group">
                <label for="photoDescription">Penjelasan Foto:</label>
                <textarea id="photoDescription" name="photo_description" placeholder="Jelaskan isi foto Anda (untuk rekomendasi judul)"></textarea>
            </div>
            <div class="form-group">
                <label for="description">Deskripsi Pin (opsional):</label>
                <textarea id="description" name="description" placeholder="Jelaskan pin Anda"></textarea>
            </div>
            <div class="form-group">
                <label for="images">Pilih Gambar (multiple diperbolehkan):</label>
                <input type="file" id="images" name="images[]" accept="image/*" multiple required>
            </div>
            <div class="form-group">
                <label>Tipe Tampilan Pin:</label>
                <div class="radio-group">
                    <input type="radio" id="displayStacked" name="display_type" value="stacked" checked>
                    <label for="displayStacked">Gambar Bertumpuk!</label>
                </div>
                <div class="radio-group">
                    <input type="radio" id="displaySlider" name="display_type" value="slider">
                    <label for="displaySlider">Slider Gambar!</label>
                </div>
            </div>
            <div id="imageDescriptionsContainer" class="form-group"></div>
            <div class="form-group">
                <label for="category">Pilih Kategori (bisa lebih dari satu):</label>
                <select id="category" name="categories[]" multiple required>
                </select>
            </div>
            <div class="form-group">
                <label for="personTags">Orang dalam Pin (pisahkan dengan koma, opsional):</label>
                <textarea id="personTags" name="personTags" placeholder="Contoh: John Doe, Jane Smith"></textarea>
                <ul id="personTagSuggestions" class="person-tag-suggestions"></ul>
            </div>
            <button type="submit" id="uploadButton">Unggah Pin <span class="loading-spinner"></span></button>
        </form>
        <div id="accessDenied" class="access-denied-message">
            Anda tidak memiliki izin untuk mengunggah pin. Harap hubungi administrator.
        </div>
    </main>

    <script>
        const API_BASE_URL = '/Spicette/api/';

        async function makeApiRequest(endpoint, method = 'GET', data = null) {
            try {
                const options = { method };
                if (data !== null && typeof data !== 'undefined') {
                    if (method === 'POST' && endpoint === 'pins.php') {
                    } else {
                        options.headers = { 'Content-Type': 'application/json' };
                        options.body = JSON.stringify(data);
                    }
                }
                
                const response = await fetch(API_BASE_URL + endpoint, options);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Kesalahan HTTP! Status: ${response.status} - ${errorText}`);
                }
                
                const textResponse = await response.text();
                if (!textResponse) {
                    return { success: true, message: 'Tidak ada konten' };
                }

                try {
                    const jsonResponse = JSON.parse(textResponse);
                    return jsonResponse;
                } catch (e) {
                    console.error('Gagal mengurai respons JSON:', textResponse);
                    throw new Error(`Respons JSON tidak valid: ${textResponse}`);
                }
            } catch (error) {
                console.error('Permintaan API Gagal:', error);
                return { success: false, message: 'Kesalahan jaringan atau server.' };
            }
        }

        async function getTitleSuggestions(categories, photoDescription, personTags) {
            const apiKey = 'sk-7ee3372f5d844af297e90551daeab578';
            const endpoint = 'https://api.deepseek.com/v1/chat/completions';
            const prompt = `You are a creative assistant tasked with generating sensual and provocative title suggestions (maximum 6 words) for a social media pin, intended for a 21+ audience for educational purposes. The titles may include bold or vulgar terms like "bitch" or "boobs" but must stay within community guidelines, avoiding explicit or overly offensive content. The pin belongs to the categories: ${categories.join(', ')}. The photo description is: "${photoDescription}". People in the pin: ${personTags.length > 0 ? personTags.join(', ') : 'None'}. Generate 3 title suggestions without using quotation marks.`;
            
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [
                            { role: 'system', content: prompt },
                            { role: 'user', content: 'Generate 3 title suggestions.' }
                        ],
                        max_tokens: 100,
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    throw new Error(`DeepSeek API error: ${response.status}`);
                }

                const data = await response.json();
                const suggestions = data.choices[0].message.content.split('\n').filter(line => line.trim());
                return suggestions.map(s => s.replace(/^\d+\.\s*/, '').trim());
            } catch (error) {
                console.error('DeepSeek API error:', error);
                return [];
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const createPinForm = document.getElementById('createPinForm');
            const accessDeniedMessage = document.getElementById('accessDenied');
            const categorySelect = document.getElementById('category');
            const imagesInput = document.getElementById('images');
            const imageDescriptionsContainer = document.getElementById('imageDescriptionsContainer');
            const displayStackedRadio = document.getElementById('displayStacked');
            const displaySliderRadio = document.getElementById('displaySlider');
            const personTagsInput = document.getElementById('personTags');
            const personTagSuggestionsContainer = document.getElementById('personTagSuggestions');
            const createMessageDiv = document.getElementById('createMessage');
            const uploadButton = document.getElementById('uploadButton');
            const recommendTitleButton = document.getElementById('recommendTitleButton');
            const titleSuggestionsDiv = document.getElementById('titleSuggestions');
            const photoDescriptionInput = document.getElementById('photoDescription');

            let allUniquePersonTags = [];
            let selectedSuggestionIndex = -1;

            function showMessage(msg, type = 'info') {
                createMessageDiv.textContent = msg;
                createMessageDiv.className = `custom-alert ${type} show`;
                setTimeout(() => {
                    createMessageDiv.classList.remove('show');
                }, 3000);
            }

            async function loadAllUniquePersonTags() {
                const response = await makeApiRequest('pins.php?action=fetch_all');
                if (response.success && response.pins) {
                    const tags = new Set();
                    response.pins.forEach(pin => {
                        if (pin.personTags && Array.isArray(pin.personTags)) {
                            pin.personTags.forEach(tag => tags.add(tag.trim()));
                        }
                    });
                    allUniquePersonTags = Array.from(tags).sort();
                }
            }

            async function loadCategories() {
                try {
                    const response = await makeApiRequest('categories.php?action=fetch_all');
                    
                    if (response.success && response.categories) {
                        categorySelect.innerHTML = '';
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = 'Pilih Kategori (opsional)';
                        defaultOption.disabled = true;
                        categorySelect.appendChild(defaultOption);

                        response.categories.forEach(cat => {
                            const option = document.createElement('option');
                            option.value = cat.name;
                            option.textContent = cat.name;
                            categorySelect.appendChild(option);
                        });
                    } else {
                        console.error('Gagal memuat kategori:', response.message);
                        showMessage('Gagal memuat kategori. Coba lagi.', 'error');
                    }
                } catch (error) {
                    console.error('Kesalahan memuat kategori:', error);
                    showMessage('Kesalahan jaringan saat memuat kategori.', 'error');
                }
            }

            function toggleDescriptions() {
                imageDescriptionsContainer.innerHTML = '';
                const files = imagesInput.files;

                if (displayStackedRadio.checked || files.length === 1) {
                    if (files.length > 0) {
                        imageDescriptionsContainer.style.display = 'block';
                        const header = document.createElement('h3');
                        header.textContent = 'Deskripsi Gambar Individual (Opsional):';
                        header.style.fontSize = '16px';
                        header.style.color = '#333';
                        header.style.marginBottom = '15px';
                        header.style.fontWeight = 'bold';
                        imageDescriptionsContainer.appendChild(header);

                        Array.from(files).forEach((file, index) => {
                            const fileDescriptionDiv = document.createElement('div');
                            fileDescriptionDiv.className = 'form-group-inline';
                            fileDescriptionDiv.innerHTML = `
                                <label for="image_desc_${index}">${file.name}:</label>
                                <textarea id="image_desc_${index}" name="image_descriptions[]" placeholder="Jelaskan gambar ini (opsional)"></textarea>
                            `;
                            imageDescriptionsContainer.appendChild(fileDescriptionDiv);
                        });
                    } else {
                        imageDescriptionsContainer.style.display = 'none';
                    }
                } else {
                    imageDescriptionsContainer.style.display = 'none';
                }

                if (files.length === 1) {
                    displayStackedRadio.checked = true;
                    displaySliderRadio.disabled = true;
                } else {
                    displaySliderRadio.disabled = false;
                }
            }

            function showPersonTagSuggestions() {
                const inputValue = personTagsInput.value;
                const lastCommaIndex = inputValue.lastIndexOf(',');
                const currentInput = (lastCommaIndex !== -1 ? inputValue.substring(lastCommaIndex + 1) : inputValue).trim().toLowerCase();

                personTagSuggestionsContainer.innerHTML = '';
                personTagSuggestionsContainer.style.display = 'none';
                selectedSuggestionIndex = -1;

                if (currentInput.length === 0) {
                    return;
                }

                const filteredSuggestions = allUniquePersonTags.filter(tag =>
                    tag.toLowerCase().includes(currentInput)
                );

                if (filteredSuggestions.length > 0) {
                    filteredSuggestions.forEach((tag, index) => {
                        const li = document.createElement('li');
                        li.textContent = tag;
                        li.dataset.index = index;
                        li.addEventListener('click', () => {
                            addPersonTagFromSuggestion(tag);
                        });
                        personTagSuggestionsContainer.appendChild(li);
                    });
                    personTagSuggestionsContainer.style.display = 'block';
                }
            }

            function addPersonTagFromSuggestion(tag) {
                let inputValue = personTagsInput.value;
                const lastCommaIndex = inputValue.lastIndexOf(',');
                
                if (lastCommaIndex !== -1) {
                    const currentTags = inputValue.substring(0, lastCommaIndex + 1).split(',').map(t => t.trim()).filter(t => t !== '');
                    if (!currentTags.includes(tag)) {
                        inputValue = inputValue.substring(0, lastCommaIndex + 1) + ' ' + tag + ', ';
                    } else {
                        inputValue = inputValue.substring(0, lastCommaIndex + 1) + ' ';
                    }
                } else {
                    if (!inputValue.split(',').map(t => t.trim()).filter(t => t !== '').includes(tag)) {
                        inputValue = tag + ', ';
                    } else {
                        inputValue = '';
                    }
                }
                personTagsInput.value = inputValue;
                personTagsInput.focus();
                personTagSuggestionsContainer.style.display = 'none';
            }

            personTagsInput.addEventListener('input', showPersonTagSuggestions);

            personTagsInput.addEventListener('keydown', (e) => {
                const items = personTagSuggestionsContainer.querySelectorAll('li');
                if (items.length === 0) return;

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    selectedSuggestionIndex = (selectedSuggestionIndex + 1) % items.length;
                    updateSelectedSuggestion();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    selectedSuggestionIndex = (selectedSuggestionIndex - 1 + items.length) % items.length;
                    updateSelectedSuggestion();
                } else if (e.key === 'Enter') {
                    if (selectedSuggestionIndex !== -1) {
                        e.preventDefault();
                        addPersonTagFromSuggestion(items[selectedSuggestionIndex].textContent);
                    }
                }
            });

            function updateSelectedSuggestion() {
                const items = personTagSuggestionsContainer.querySelectorAll('li');
                items.forEach((item, index) => {
                    if (index === selectedSuggestionIndex) {
                        item.classList.add('selected');
                        item.scrollIntoView({ block: 'nearest' });
                    } else {
                        item.classList.remove('selected');
                    }
                });
            }

            personTagsInput.addEventListener('blur', () => {
                setTimeout(() => {
                    if (!personTagSuggestionsContainer.contains(document.activeElement)) {
                        personTagSuggestionsContainer.style.display = 'none';
                    }
                }, 100);
            });

            personTagSuggestionsContainer.addEventListener('mousedown', (e) => {
                e.preventDefault();
            });

            recommendTitleButton.addEventListener('click', async () => {
                const selectedCategories = Array.from(categorySelect.selectedOptions).map(option => option.value);
                const photoDescription = photoDescriptionInput.value.trim();
                const personTagsValue = personTagsInput.value.trim();
                const personTagsArray = personTagsValue ? personTagsValue.split(',').map(tag => tag.trim()).filter(tag => tag !== '') : [];

                if (selectedCategories.length === 0) {
                    showMessage('Pilih setidaknya satu kategori.', 'error');
                    return;
                }

                if (!photoDescription) {
                    showMessage('Masukkan penjelasan foto.', 'error');
                    return;
                }

                recommendTitleButton.disabled = true;
                const suggestions = await getTitleSuggestions(selectedCategories, photoDescription, personTagsArray);
                recommendTitleButton.disabled = false;

                titleSuggestionsDiv.innerHTML = '';
                if (suggestions.length > 0) {
                    suggestions.forEach(suggestion => {
                        const suggestionElement = document.createElement('div');
                        suggestionElement.className = 'title-suggestion';
                        suggestionElement.textContent = suggestion;
                        suggestionElement.addEventListener('click', () => {
                            document.getElementById('title').value = suggestion;
                        });
                        titleSuggestionsDiv.appendChild(suggestionElement);
                    });
                } else {
                    showMessage('Gagal mendapatkan saran judul.', 'error');
                }
            });

            loadCategories();
            toggleDescriptions();
            loadAllUniquePersonTags();

            displayStackedRadio.addEventListener('change', toggleDescriptions);
            displaySliderRadio.addEventListener('change', toggleDescriptions);
            imagesInput.addEventListener('change', toggleDescriptions);
            
            createPinForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                uploadButton.disabled = true;

                const form = event.target;
                const formData = new FormData();

                formData.append('title', document.getElementById('title').value);
                formData.append('description', document.getElementById('description').value);
                formData.append('display_type', document.querySelector('input[name="display_type"]:checked').value);

                const selectedCategories = Array.from(categorySelect.selectedOptions).map(option => option.value);
                if (selectedCategories.length === 0) {
                    showMessage('Harap pilih setidaknya satu kategori.', 'error');
                    uploadButton.disabled = false;
                    return;
                }
                formData.append('categories', JSON.stringify(selectedCategories));

                const personTagsValue = personTagsInput.value.trim();
                let personTagsArray = [];
                if (personTagsValue) {
                    personTagsArray = personTagsValue.split(',').map(tag => tag.trim()).filter(tag => tag !== '');
                }
                formData.append('personTags', JSON.stringify(personTagsArray));

                if (imagesInput.files.length === 0) {
                    showMessage('Harap pilih setidaknya satu gambar.', 'error');
                    uploadButton.disabled = false;
                    return;
                }
                for (const file of imagesInput.files) {
                    formData.append('images[]', file);
                }

                if (document.getElementById('displayStacked').checked && imagesInput.files.length > 0) {
                    const imageDescriptions = [];
                    const descriptionTextareas = document.querySelectorAll('#imageDescriptionsContainer textarea[name="image_descriptions[]"]');
                    descriptionTextareas.forEach(textarea => {
                        imageDescriptions.push(textarea.value);
                    });
                    formData.append('image_descriptions', JSON.stringify(imageDescriptions));
                }

                try {
                    const response = await fetch('./api/pins.php', {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        showMessage('Pin berhasil dibuat!', 'success');
                        form.reset();
                        document.getElementById('imageDescriptionsContainer').innerHTML = '';
                        document.getElementById('displaySlider').disabled = false;
                        document.getElementById('displayStacked').checked = true;
                        Array.from(categorySelect.options).forEach(option => {
                            option.selected = false;
                        });
                        personTagsInput.value = '';
                        titleSuggestionsDiv.innerHTML = '';
                        
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 1500);
                    } else {
                        showMessage('Gagal membuat pin: ' + result.message + (result.errors ? '\n' + result.errors.join('\n') : ''), 'error');
                    }
                } catch (error) {
                    console.error('Kesalahan:', error);
                    showMessage('Kesalahan jaringan selama unggah.', 'error');
                } finally {
                    uploadButton.disabled = false;
                }
            });

            const userSessionResponse = await makeApiRequest('auth.php?action=check_session', 'GET');
            if (!userSessionResponse.success || !userSessionResponse.user || !userSessionResponse.user.canUpload) {
                createPinForm.style.display = 'none';
                accessDeniedMessage.style.display = 'block';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 3000);
                return;
            }
        });
    </script>
</body>
</html>