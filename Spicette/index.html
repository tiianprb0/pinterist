<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spicette</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
<style>
/* Simple CSS Reset */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Plus Jakarta Sans', sans-serif; /* Menggunakan font Plus Jakarta Sans */
    background-color: #f9f9f9;
    color: #333;
    overscroll-behavior: none;
}

/* Header Styling (Desktop & Mobile) */
header {
    background-color: #fff;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: none; /* Dihilangkan box-shadow */
    height: 70px;
    transition: transform 0.3s ease-in-out;
}

.logo {
    width: 36px;
    height: 36px;
    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" fill="%23E60023"><path d="M256 8C119.1 8 8 119.1 8 256s111.1 248 248 248 248-111.1 248-248S392.9 8 256 8zm119.3 270.5c-5.3 14.9-17.5 31.9-41.1 31.9-29.3 0-44.3-21.3-44.3-47.1 0-30.1 19.9-51.3 19.9-51.3s-10.7-43.1-10.7-52.3c0-18.3 12.9-31.3 27.5-31.3 13.1 0 19.3 7.7 19.3 20.3 0 14.1-9.5 35.5-9.5 35.5s6.7-22.5 22.5-22.5c26.1 0 41.5 20.3 41.5 46.5 0 26.7-14.5 44.9-36.1 44.9-7.9 0-14.1-3.7-14.1-3.7s-2.9 11.1-3.9 14.7c-3.5 11.7-10.1 24.7-10.1 24.7s3.9 1.7 8.1 1.7c23.7 0 41.3-20.1 47.1-35.3 3.3-9.3 2.1-19.3 2.1-29.5 0-23.1-5.5-37.9-16.7-50.3-10.9-11.9-27.7-19.9-47.5-19.9-35.7 0-61.9 27.1-61.9 60.9 0 20.7 10.3 39.5 25.9 47.7 1.7 1.1 2.5 1.1 3.3 0 1.7-2.3.9-5.1.9-7.5 0-5.5-2.1-10.1-2.1-10.1s-17.3 71.1-21.1 83.7c-10.5 35.5-30.1 61.5-59.5 61.5-34.5 0-59.3-27.9-59.3-66.1 0-34.3 21.5-64.7 58.1-64.7 18.3 0 30.7 7.7 30.7 24.1 0 13.1-7.5 30.9-12.3 47.7-2.9 10.3-2.3 22.7.9 31.9 3.7 11.5 14.1 20.5 27.9 20.5 18.3 0 30.9-15.3 30.9-39.5 0-18.5-11.1-32.9-29.5-44.3-14.9-9.1-21.5-22.5-21.5-38.7 0-27.3 18.5-49.5 52.1-49.5 27.7 0 43.7 16.5 43.7 40.7 0 21.3-10.1 35.5-25.3 35.5-6.7 0-12.7-4.9-13.3-13.3 0-10.1 6.1-21.7 6.1-21.7z"/></svg>');
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    margin-right: 8px;
    cursor: pointer;
}
        
.header-nav-links {
    display: flex;
    align-items: center;
}

.nav-button {
    padding: 12px 16px; font-weight: bold; border-radius: 24px; cursor: pointer; transition: background-color 0.2s ease; font-size: 16px; border: none;
}
.nav-button.active { background-color: #111; color: white; }
.nav-button:not(.active) { background-color: transparent; color: #111; }
.nav-button:hover { background-color: #e9e9e9; }
.nav-button.active:hover { background-color: #333; }
        
.search-container { flex-grow: 1; margin: 0 10px; display: flex; align-items: center; }
.search-container input[type="search"] { width: 100%; padding: 12px 20px 12px 45px; border: none; background-color: #efefef; border-radius: 24px; font-size: 16px; outline: none; }
.search-container input[type="search"]:focus { background-color: #e0e0e0; }
.search-icon-wrapper { position: relative; display: flex; align-items: center; width: 100%; }
.search-icon-wrapper svg { position: absolute; left: 15px; width: 18px; height: 18px; fill: #767676; }

.header-icons { display: flex; align-items: center; }
.icon-button { background: none; border: none; padding: 8px; margin-left: 8px; cursor: pointer; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s ease; position: relative; }
.icon-button:hover { background-color: #e9e9e9; }
.icon-button svg { width: 24px; height: 24px; fill: #5f5f5f; }
.profile-icon { width: 28px; height: 28px; background-color: #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; color: #767676; }
.mobile-notification-icon { display: none; }

.notification-badge {
    position: absolute; top: 8px; right: 5px; background-color: #e60023;
    color: white; border-radius: 50%; width: 18px; height: 18px;
    font-size: 11px; font-weight: bold; display: flex;
    align-items: center; justify-content: center; border: 2px solid white;
}

/* Overlays (Search, Login, Add Pin) */
#searchOverlay, #loginOverlay, #addPinOverlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background-color: #fff; z-index: 1100;
    display: none; flex-direction: column;
    padding-top: 15px;
}
.overlay-header { display: flex; align-items: center; padding: 0 15px; margin-bottom: 15px; }
.overlay-header .search-container { margin: 0; }
.overlay-header button { background: none; border: none; font-size: 16px; font-weight: bold; color: #111; cursor: pointer; margin-left: 10px; padding: 8px; }

.overlay-content { padding: 0 15px; overflow-y: auto; }
.overlay-content h3, .desktop-categories h3 { 
    font-size: 16px; color: #333; margin-bottom: 15px; font-weight: bold; 
}

/* NEW: Search Suggestions */
#searchSuggestions {
    list-style: none;
    padding: 0;
    margin: 10px 0;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid #eee;
}
#searchSuggestions li {
    padding: 10px 15px;
    cursor: pointer;
    font-size: 15px;
    color: #333;
    transition: background-color 0.2s ease;
}
#searchSuggestions li:hover {
    background-color: #f0f0f0;
}
#searchSuggestions li.selected { /* Untuk navigasi keyboard */
    background-color: #e60023;
    color: white;
}


.category-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 15px;
}
.desktop-categories {
    padding: 0 20px;
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out, opacity 0.4s ease-out, margin-bottom 0.4s ease-out;
    margin-bottom: 0;
}
main.desktop-search-active .desktop-categories {
    max-height: 400px; /* Adjust as needed */
    opacity: 1;
    margin-bottom: 20px;
}
.category-item {
    position: relative;
    aspect-ratio: 1 / 1;
    border-radius: 16px;
    overflow: hidden;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: bold;
    font-size: 16px;
    text-align: center;
    background-size: cover;
    background-position: center;
    transition: transform 0.2s ease;
}
.category-item:hover {
    transform: scale(1.03);
}
.category-item::after {
    content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.3); transition: background 0.2s ease;
}
.category-item:hover::after { background: rgba(0,0,0,0.5); }
.category-item span {
    position: relative; z-index: 2;
    text-shadow: 0 1px 3px rgba(0,0,0,0.5); padding: 5px;
}

/* Main Content - Pin Grid Styling */
main { padding-top: 20px; }
.pin-grid { column-count: 5; column-gap: 15px; padding: 0 20px; }
.pin { display: inline-block; width: 100%; margin-bottom: 15px; border-radius: 16px; overflow: hidden; position: relative; cursor: pointer; background-color: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.pin img { width: 100%; height: auto; display: block; border-radius: 16px; }
.pin-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to top, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0) 50%); opacity: 0; transition: opacity 0.3s ease; display: flex; flex-direction: column; justify-content: space-between; padding: 12px; }
.pin:hover .pin-overlay { opacity: 1; }
.pin-overlay-top { display: flex; justify-content: flex-end; }
.pin-overlay-bottom { display: flex; flex-direction: column; align-items: flex-start; } /* Changed to column */

.pin-save-button { background-color: #e60023; color: white; border: none; padding: 12px 16px; border-radius: 24px; font-weight: bold; font-size: 14px; cursor: pointer; }

/* PERBAIKAN: Tombol download agar tetap lingkaran */
.pin-action-icon {
    background: rgba(255,255,255,0.9);
    border: none;
    border-radius: 50%; /* Menjamin bentuk lingkaran */
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    flex-shrink: 0; /* Mencegah memanjang */
    padding: 0; /* Hapus padding yang mungkin membuat melonjong */
}
.pin-action-icon svg { width: 18px; height: 18px; fill: #111; }

.pin-info { color: white; font-size: 12px; text-shadow: 0 1px 3px rgba(0,0,0,0.7); width: 100%; } /* Added width 100% */
.pin-info a { color: white; text-decoration: none; font-weight: bold; }
.pin-title { color: white; font-size: 14px; font-weight: bold; text-shadow: 0 1px 3px rgba(0,0,0,0.7); margin-bottom: 5px; }
.pin-bottom-actions { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-top: 5px; } /* New container for actions */

/* NEW: Pin Detail Overlay */
#pinDetailOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f9f9f9; /* Background sesuai body */
    z-index: 1200; /* Di atas overlay lain */
    display: none; /* Default hidden */
    flex-direction: column;
    overflow-y: auto;
}
#pinDetailOverlay .overlay-header {
    background-color: #fff;
    position: sticky; /* Sticky, bukan fixed, agar header detail bisa ikut scroll jika konten banyak */
    top: 0;
    left: 0;
    width: 100%;
    height: 70px;
    box-shadow: none; /* No shadow */
    z-index: 1201; /* Di atas overlay detail */
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: flex-end; /* Untuk tombol close di kanan */
}
#pinDetailOverlay .overlay-header button {
    margin-left: 0; /* Hapus margin default */
}
.pin-detail-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    max-width: 800px; /* Maksimal lebar konten */
    margin: 0 auto;
    width: 100%;
    flex-grow: 1; /* Biarkan konten mengisi sisa ruang */
}
.pin-detail-img-container {
    width: 100%;
    max-width: 500px; /* Max width for image */
    border-radius: 16px;
    overflow: hidden;
    margin-bottom: 20px;
    background-color: #e0e0e0;
}
.pin-detail-img-container img {
    width: 100%;
    height: auto;
    display: block;
}
.pin-detail-info {
    text-align: center;
    margin-bottom: 20px; /* Kurangi margin bawah */
    color: #333;
    width: 100%; /* Memastikan info memenuhi lebar */
}
.pin-detail-info h2 {
    font-size: 28px;
    margin-bottom: 10px;
    color: #111;
}
.pin-detail-info p {
    font-size: 16px;
    color: #555;
    margin-bottom: 5px;
}
/* NEW: Styling for pin content/description */
.pin-detail-description {
    text-align: left; /* Teks deskripsi rata kiri */
    margin-top: 15px; /* Jarak dari info lainnya */
    margin-bottom: 20px; /* Jarak ke tombol */
    font-size: 15px;
    line-height: 1.5;
    color: #444;
}
.pin-detail-info a {
    color: #007bff;
    text-decoration: none;
    font-weight: bold;
}
.pin-detail-info a:hover {
    text-decoration: underline;
}
/* PERBAIKAN: Tombol simpan dan unduh satu baris */
.pin-detail-actions {
    display: flex;
    flex-wrap: wrap; /* Izinkan wrapping jika terlalu sempit */
    justify-content: center; /* Pusatkan tombol */
    gap: 15px; /* Jarak antar tombol */
    width: 100%;
    margin-bottom: 20px; /* Tambahkan margin bawah agar tidak terlalu mepet ke footer */
}
.pin-detail-actions button {
    background-color: #e60023;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 24px;
    font-weight: bold;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.2s ease;
    flex-grow: 1; /* Agar tombol bisa memanjang di mobile jika wrap */
    max-width: 200px; /* Batasi lebar maksimum */
}
.pin-detail-actions button.secondary {
    background-color: #5f5f5f;
}
.pin-detail-actions button:hover {
    background-color: #ad081b;
}
.pin-detail-actions button.secondary:hover {
    background-color: #767676;
}

/* NEW: Notification Overlay (Instead of modal) */
#notificationOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f9f9f9;
    z-index: 1200;
    display: none;
    flex-direction: column;
    overflow-y: auto;
}
#notificationOverlay .overlay-header {
    background-color: #fff;
    position: sticky; /* Sticky, bukan fixed */
    top: 0;
    left: 0;
    width: 100%;
    height: 70px;
    box-shadow: none; /* No shadow */
    z-index: 1201;
    padding: 10px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
}
#notificationOverlay .overlay-header h2 {
    font-size: 24px;
    color: #111;
    margin: 0;
}
.notification-page-container {
    max-width: 800px;
    margin: 20px auto;
    padding: 0 20px;
    width: 100%;
}
.notification-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}
.notification-item {
    background-color: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    border: 1px solid #eee;
    font-size: 15px;
    color: #333;
    position: relative;
}
.notification-item + .notification-item { /* Garis putus-putus antar notifikasi */
    margin-top: 10px;
    padding-top: 20px;
    border-top: 1px dashed #ddd;
}
.notification-item.read {
    background-color: #f0f0f0;
    color: #777;
}


/* Modal (messageModal) dihapus */
#messageModal { display: none !important; } 

/* Mobile Bottom Navigation */
.mobile-bottom-nav-container { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1001; }
.mobile-bottom-nav { display: flex; padding: 8px; gap: 8px; background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.3); box-shadow: 0 4px 20px rgba(0,0,0,0.1); border-radius: 30px; }
.mobile-nav-item { display: flex; align-items: center; justify-content: center; cursor: pointer; color: #333; width: 50px; height: 50px; border-radius: 50%; transition: background-color 0.2s ease, color 0.2s ease; }
.mobile-nav-item:hover { background-color: rgba(0, 0, 0, 0.05); }
.mobile-nav-item.active { background-color: #111; color: #fff; }
.mobile-nav-item svg { width: 26px; height: 26px; fill: currentColor; }
.mobile-nav-item .profile-icon { background-color: #e0e0e0; color: #333; }
.mobile-nav-item.active .profile-icon { background-color: #fff; color: #111; }

#loading-indicator { text-align: center; padding: 20px; font-style: italic; color: #767676; }

/* Login Overlay Specifics */
#loginOverlay .overlay-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: calc(100% - 70px);
}
#loginOverlay .login-form {
    background-color: #fff;
    padding: 30px;
    border-radius: 16px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    width: 100%;
    max-width: 350px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    text-align: center;
}
#loginOverlay .login-form h2 {
    margin-bottom: 20px;
    color: #111;
    font-size: 24px;
}
#loginOverlay .login-form input {
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 16px;
    width: calc(100% - 24px);
}
#loginOverlay .login-form button {
    background-color: #e60023;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 24px;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}
#loginOverlay .login-form button:hover {
    background-color: #ad081b;
}
#loginOverlay .register-text {
    margin-top: 15px;
    font-size: 14px;
    color: #5f5f5f;
}
#loginOverlay .register-text a {
    color: #111;
    font-weight: bold;
    text-decoration: none;
}
#loginOverlay .register-text a:hover {
    text-decoration: underline;
}

/* Clean and Elegant Add Pin Overlay */
#addPinOverlay .add-pin-form {
    background-color: #fff;
    padding: 30px;
    border-radius: 16px;
    box-shadow: none; /* No box-shadow for a cleaner look */
    width: 100%;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    gap: 15px;
    text-align: center;
    border: 1px solid #eee; /* Subtle border */
}
#addPinOverlay .add-pin-form h2 {
    font-size: 28px;
    color: #333;
    margin-bottom: 25px;
    font-weight: normal;
}
#addPinOverlay .add-pin-form input,
#addPinOverlay .add-pin-form textarea { /* Tambah textarea */
    padding: 12px;
    border: 1px solid #ccc;
    background-color: #f8f8f8;
    border-radius: 8px;
    font-size: 16px;
    width: 100%;
    box-sizing: border-box;
}
#addPinOverlay .add-pin-form textarea {
    min-height: 80px;
    resize: vertical;
}

#addPinOverlay .add-pin-form button {
    background-color: #111; /* Darker button for elegance */
    transition: background-color 0.3s ease;
}
#addPinOverlay .add-pin-form button:hover {
    background-color: #333;
}


/* Dropdown for More Accounts */
.dropdown-menu {
    position: absolute;
    top: 60px;
    right: 10px;
    background-color: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    padding: 10px 0;
    min-width: 180px;
    display: none;
    z-index: 1000;
    list-style: none;
}

.dropdown-menu li {
    padding: 8px 15px;
    cursor: pointer;
    font-size: 15px;
    color: #333;
    transition: background-color 0.2s ease;
}
.dropdown-menu li:hover {
    background-color: #f0f0f0;
}
.dropdown-menu li.header-item {
    font-weight: bold;
    color: #555;
    border-bottom: 1px solid #eee;
    margin-bottom: 5px;
    padding-bottom: 5px;
    cursor: default;
}
/* Mobile Profile Dropdown (Sederhana, bisa dikembangkan) */
#mobileProfileDropdown {
    position: fixed;
    bottom: 80px; /* Above mobile nav */
    left: 50%;
    transform: translateX(-50%);
    background-color: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 15px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    z-index: 1002;
    display: none;
    flex-direction: column;
    gap: 10px;
    width: 80%;
    max-width: 250px;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.3); /* Glassmorphism border */
}
#mobileProfileDropdown button {
    background-color: #e60023;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 20px;
    font-weight: bold;
    cursor: pointer;
    font-size: 15px;
}
#mobileProfileDropdown button.secondary {
    background-color: #767676;
}
#mobileProfileDropdown button:hover {
    opacity: 0.9;
}
#mobileProfileDropdown .username-display {
    font-weight: bold;
    margin-bottom: 10px;
    color: #333;
}


/* Admin & User Page Specifics (for use in admin.php and user.php) */
.admin-page-container, .user-page-container {
    max-width: 1200px;
    margin: 20px auto;
    padding: 20px;
    background-color: #fff;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.admin-page-header, .user-page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}

.admin-page-header h1, .user-page-header h1 {
    color: #E60023;
    margin: 0;
    font-size: 28px;
}

.admin-logout-btn, .user-logout-btn {
    background-color: #555;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 24px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s ease;
}
.admin-logout-btn:hover, .user-logout-btn:hover {
    background-color: #777;
}

.admin-section, .user-section {
    margin-bottom: 40px;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 25px;
    background-color: #fcfcfc;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
}

.admin-section h2, .user-section h2 {
    color: #111;
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 22px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
}

.admin-form, .user-form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.admin-form input, .admin-form textarea, .user-form input, .user-form textarea {
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    width: 100%;
    box-sizing: border-box;
}
.admin-form textarea {
    min-height: 80px;
    resize: vertical;
}
.admin-form button, .user-form button {
    background-color: #E60023;
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 24px;
    font-weight: bold;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}
.admin-form button:hover, .user-form button:hover {
    background-color: #ad081b;
}
.admin-form button.secondary, .user-form button.secondary {
    background-color: #5f5f5f;
}
.admin-form button.secondary:hover, .user-form button.secondary:hover {
    background-color: #767676;
}

.admin-list, .user-details-list {
    margin-top: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.list-item {
    display: flex;
    align-items: center;
    background-color: #fff;
    padding: 12px 15px;
    border-radius: 10px;
    border: 1px solid #eee;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    flex-wrap: wrap;
}

.list-item-content {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    font-size: 14px;
    color: #333;
}
.list-item-content strong {
    font-size: 16px;
    margin-bottom: 5px;
    color: #111;
}
.list-item-content span {
    color: #555;
}
.list-item-img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
    margin-right: 15px;
    flex-shrink: 0;
}

.list-item-actions {
    margin-left: 20px;
    display: flex;
    gap: 8px;
    flex-shrink: 0;
}
.list-item-actions button {
    background-color: #e60023;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 20px;
    cursor: pointer;
    font-size: 13px;
    font-weight: bold;
    transition: background-color 0.2s ease;
}
.list-item-actions button.delete-btn {
    background-color: #999;
}
.list-item-actions button:hover {
    opacity: 0.9;
}

#message {
    margin-top: 15px;
    padding: 10px;
    border-radius: 5px;
    color: green;
    background-color: #e6ffe6;
    border: 1px solid green;
    display: none;
}
#message.error {
    color: red;
    background-color: #ffe6e6;
    border: 1px solid red;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .admin-page-container, .user-page-container {
        margin: 10px;
        padding: 15px;
    }
    .admin-page-header, .user-page-header {
        flex-direction: column;
        align-items: flex-start;
    }
    .admin-logout-btn, .user-logout-btn {
        margin-top: 10px;
        width: 100%;
    }
    .list-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    .list-item-img {
        margin-right: 0;
        margin-bottom: 10px;
    }
    .list-item-actions {
        margin-left: 0;
        width: 100%;
        justify-content: flex-end;
    }

    /* SPECIFIC MOBILE HEADER HIDING */
    header .search-container { /* Hide desktop search bar */
        display: none; 
    }
    /* Hide desktop create button using its ID for higher specificity */
    #desktopCreateButton { 
        display: none; 
    }
    /* Hide desktop profile/more accounts icons in header, ONLY show mobile notification */
    .header-icons .icon-button:not(.mobile-notification-icon) {
        display: none; 
    }
    .mobile-notification-icon { 
        display: flex; 
        margin-left: auto; /* Push to right */
    }
    .mobile-bottom-nav-container { 
        display: block; 
    }
    .desktop-categories { 
        display: none; 
    }
    .pin-grid { column-count: 2; column-gap: 10px; padding: 0 10px; }
    main { padding-top: 10px; padding-bottom: 100px; }
    .pin { margin-bottom: 10px; }

    /* Adjust overlays for mobile */
    #searchOverlay .overlay-header,
    #loginOverlay .overlay-header,
    #addPinOverlay .overlay-header {
        padding: 0 10px;
    }
    #loginOverlay .overlay-content,
    #addPinOverlay .overlay-content {
        justify-content: flex-start; /* Align to top for smaller screens */
        padding-top: 50px;
    }

    /* Pin Detail Overlay responsive */
    #pinDetailOverlay {
        /* padding-top is already handled by fixed header */
    }
    #pinDetailOverlay .overlay-header {
        position: fixed; /* Make header fixed on mobile for detail view */
        padding-top: 0;
    }
    .pin-detail-content {
        padding: 10px;
        margin-top: 70px; /* Offset for fixed header */
    }
    .pin-detail-info h2 {
        font-size: 22px;
    }
    .pin-detail-info p {
        font-size: 14px;
    }
    .pin-detail-actions {
        flex-direction: column; /* Tombol stack vertikal di mobile */
        width: 100%;
    }
    .pin-detail-actions button {
        width: 100%;
        max-width: none; /* Izinkan tombol mengambil lebar penuh */
    }

    /* Notification Overlay responsive */
    #notificationOverlay {
        /* padding-top is already handled by fixed header */
    }
    #notificationOverlay .overlay-header {
        position: fixed; /* Make header fixed on mobile for notification view */
        padding-top: 0;
    }
    .notification-page-container {
        padding: 0 10px;
        margin-top: 70px; /* Offset for fixed header */
    }
    .notification-item {
        padding: 10px;
    }
}
        
@media (max-width: 480px) { .search-icon-wrapper svg { left: 12px; width: 16px; height: 16px; } }
</style>
</head>
<body>

    <div id="pinDetailOverlay">
        <div class="overlay-header">
            <button class="icon-button" aria-label="Tutup Detail Pin" id="closePinDetailButton">
                <svg viewBox="0 0 24 24" fill="#5f5f5f" width="24px" height="24px"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div class="pin-detail-content">
            <div class="pin-detail-img-container">
                <img id="pinDetailImage" src="" alt="Detail Pin">
            </div>
            <div class="pin-detail-info">
                <h2 id="pinDetailTitle"></h2>
                <p>Diunggah oleh: <strong id="pinDetailUploadedBy"></strong></p>
                <p id="pinDetailSourceDisplay"></p> <p id="pinDetailDescription" class="pin-detail-description"></p> </div>
            <div class="pin-detail-actions">
                <button id="pinDetailSaveButton" class="pin-save-button">Simpan</button>
                <button id="pinDetailDownloadButton" class="secondary">Unduh</button>
            </div>
        </div>
    </div>

    <div id="notificationOverlay">
        <div class="overlay-header">
            <h2>Notifikasi</h2>
            <button class="icon-button" aria-label="Tutup Notifikasi" id="closeNotificationButton">
                <svg viewBox="0 0 24 24" fill="#5f5f5f" width="24px" height="24px"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
        </div>
        <div class="notification-page-container">
            <div class="notification-list" id="notificationListContainer">
                <p style="text-align: center; color: #767676;">Tidak ada notifikasi.</p>
            </div>
        </div>
    </div>
    
    <div id="searchOverlay">
        <div class="overlay-header search-overlay-header">
            <div class="search-container">
                <div class="search-icon-wrapper">
                    <svg aria-hidden="true" aria-label="Search" role="img" viewBox="0 0 24 24"><path d="M10 16c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6m13.12 2.88-4.26-4.26A9.842 9.842 0 0 0 20 10c0-5.52-4.48-10-10-10S0 4.48 0 10s4.48 10 10 10c1.67 0 3.24-.41 4.62-1.14l4.26 4.26a3 3 0 0 0 4.24 0 3 3 0 0 0 0-4.24"></path></svg>
                    <input type="search" placeholder="Cari ide" id="mobileSearchInputOverlay">
                </div>
            </div>
            <button id="closeSearchOverlay">Batal</button>
        </div>
        <div class="overlay-content search-overlay-content">
            <h3>Ide untuk dijelajahi</h3>
            <ul id="searchSuggestions"></ul> <div id="searchResults" class="pin-grid"></div> <div id="searchLoadingIndicator" style="text-align: center; padding: 20px; font-style: italic; color: #767676; display: none;">Mencari...</div>
            <h3 id="categoryExploreTitle">Jelajahi Kategori</h3> <div class="category-grid" id="categoryGridMobile">
                </div>
        </div>
    </div>

    <div id="loginOverlay">
        <div class="overlay-header">
            <button id="closeLoginOverlay">Batal</button>
        </div>
        <div class="overlay-content">
            <form class="login-form" id="loginForm">
                <h2>Selamat datang kembali!</h2>
                <input type="text" id="loginUsername" placeholder="Nama Pengguna" required>
                <input type="password" id="loginPassword" placeholder="Kata Sandi" required>
                <button type="submit">Login</button>
                <p class="register-text">Belum punya akun? <a href="#" id="showRegister">Daftar</a></p>
                <p class="register-text">Login sebagai <a href="#" id="loginAsAdmin">Admin</a></p>
            </form>
            <form class="login-form" id="registerForm" style="display:none;">
                <h2>Gabung Spicette</h2>
                <input type="text" id="registerUsername" placeholder="Nama Pengguna" required>
                <input type="password" id="registerPassword" placeholder="Kata Sandi" required>
                <button type="submit">Daftar</button>
                <p class="register-text">Sudah punya akun? <a href="#" id="showLogin">Login</a></p>
            </form>
        </div>
    </div>

    <div id="addPinOverlay">
        <div class="overlay-header">
            <button id="closeAddPinOverlay">Batal</button>
        </div>
        <div class="overlay-content">
            <form class="add-pin-form" id="addPinForm">
                <h2>Buat Pin Baru</h2>
                <input type="text" id="newPinTitle" placeholder="Judul Pin" required>
                <textarea id="newPinContent" placeholder="Isi postingan (opsional)"></textarea> <input type="text" id="newPinImageURL" placeholder="URL Gambar" required>
                <input type="text" id="newPinSource" placeholder="Sumber (opsional, contoh: example.com)"> <button type="submit">Unggah Pin</button>
            </form>
        </div>
    </div>

    <div id="mobileProfileDropdown">
        <span class="username-display" id="mobileDropdownUsernameDisplay"></span>
        <button id="mobileDropdownMyProfile" style="display: none;">Profil Saya</button>
        <button id="mobileDropdownAdminPanel" style="display: none;">Panel Admin</button>
        <button id="mobileDropdownLogout">Logout</button>
        <button class="secondary" id="mobileDropdownClose">Tutup</button>
    </div>


    <header>
        <div class="logo" onclick="showMessage('Spicette Logo Diklik!')"></div>
        <div class="header-nav-links">
            <button class="nav-button active" data-nav="home">Beranda</button>
            <button class="nav-button" data-nav="create" id="desktopCreateButton">Buat</button>
            <button class="nav-button saved" data-nav="saved">Disimpan</button>
        </div>

        <div class="search-container">
            <div class="search-icon-wrapper">
                <svg aria-hidden="true" aria-label="Search" role="img" viewBox="0 0 24 24"><path d="M10 16c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6m13.12 2.88-4.26-4.26A9.842 9.842 0 0 0 20 10c0-5.52-4.48-10-10-10S0 4.48 0 10s4.48 10 10 10c1.67 0 3.24-.41 4.62-1.14l4.26 4.26a3 3 0 0 0 4.24 0 3 3 0 0 0 0-4.24"></path></svg>
                <input type="search" placeholder="Cari" id="desktopSearchInput">
                <ul id="desktopSearchSuggestions"></ul> </div>
        </div>
        <div class="header-icons">
            <button class="icon-button" aria-label="Notifikasi" id="notificationButton">
                <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"></path></svg>
                <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
            <button class="icon-button" aria-label="Profil" id="profileButton"><div class="profile-icon" id="profileIconLetter">G</div></button>
            <button class="icon-button" aria-label="Akun lainnya" id="moreAccountsButton"><svg viewBox="0 0 24 24" fill="#5f5f5f" width="24px" height="24px"><path d="M7 10l5 5 5-5H7z"></path></svg></button>
            <ul class="dropdown-menu" id="moreAccountsDropdown">
                <li class="header-item" id="dropdownUsernameDisplay">Selamat Datang, Tamu!</li>
                <li id="dropdownMyProfile" style="display: none;">Profil Saya</li>
                <li id="dropdownAdminPanel" style="display: none;">Panel Admin</li>
                <li id="dropdownLogout" style="display: none;">Logout</li>
            </ul>
        </div>
        <button class="icon-button mobile-notification-icon" aria-label="Notifikasi" id="mobileNotificationButton">
               <svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"></path></svg>
               <span class="notification-badge" id="mobileNotificationBadge" style="display: none;">0</span>
        </button>
    </header>
    
    <main>
        <section class="desktop-categories">
            <h3>Ide untuk dijelajahi</h3>
            <div class="category-grid" id="categoryGridDesktop">
                </div>
        </section>
        <div class="pin-grid" id="pinGrid"></div>
        <div id="loading-indicator">Memuat pin lainnya...</div>
    </main>

    <div class="mobile-bottom-nav-container">
        <nav class="mobile-bottom-nav">
            <div class="mobile-nav-item active" data-action="home">
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"></path></svg>
            </div>
            <div class="mobile-nav-item" data-action="search">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0 0 16 9.5 6.5 6.5 0 1 0 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
            </div>
            <div class="mobile-nav-item" data-action="create-pin">
                   <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"></path></svg>
            </div>
            <div class="mobile-nav-item" data-action="profile">
                <div class="profile-icon" style="width:28px; height:28px;">G</div>
            </div>
        </nav>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Global State ---
            let currentUser = null;
            let currentSearchQuery = ''; 
            let allPinsData = []; // Store all pins data for direct access by ID
            const NOTIFICATION_LS_KEY_READ_STATUS = 'spicette_notifications_read';
            let searchSuggestionsData = []; // To store data for suggestions
            let selectedSuggestionIndex = -1; // For keyboard navigation in suggestions

            // --- API Endpoints ---
            const API_BASE_URL = 'api/';

            // --- Helper Function for API Requests ---
            async function makeApiRequest(endpoint, method = 'GET', data = null) {
                try {
                    const options = { method };
                    if (data !== null && typeof data !== 'undefined') {
                        options.headers = { 'Content-Type': 'application/json' };
                        options.body = JSON.stringify(data);
                    } else if (method === 'POST') {
                        delete options.headers; 
                    }
                    
                    const response = await fetch(API_BASE_URL + endpoint, options);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! Status: ${response.status} - ${errorText}`);
                    }
                    
                    const textResponse = await response.text();
                    if (!textResponse) {
                        return { success: true, message: 'No content' };
                    }

                    try {
                        const jsonResponse = JSON.parse(textResponse);
                        return jsonResponse;
                    } catch (e) {
                        console.error('Failed to parse JSON response:', textResponse);
                        throw new Error(`Invalid JSON response: ${textResponse}`);
                    }

                } catch (error) {
                    console.error('API Request Gagal:', error);
                    // showMessage(`Error jaringan atau server: ${error.message}`, 'Error'); // Notifikasi ini diganti dengan overlay
                    return { success: false, message: 'Error jaringan atau server.' };
                }
            }

            // --- Function to Display Messages (for general errors/success, not for tab changes/notifications now) ---
            // Digunakan untuk pesan yang bukan notifikasi atau detail pin, seperti error login/add pin
            function showMessage(message, title = null) {
                // Abaikan notifikasi perpindahan tab atau pesan kosong
                const ignoredMessages = ['Beralih ke halaman Beranda', 'Menampilkan pin yang Anda simpan.', 'No content', 'Memuat pin lainnya...'];
                if (title === null && ignoredMessages.includes(message)) {
                    return; 
                }

                // Untuk pesan sukses/error umum yang masih perlu popup, kita bisa gunakan alert atau console.log
                // Untuk kesederhanaan, kita akan menggunakan alert, tapi disarankan modal kustom yang berbeda
                if (title) {
                    alert(`${title}: ${message}`);
                } else {
                    console.log(message); // Atau alert(message);
                }
            }
            
            // --- Pin Detail Overlay Logic ---
            const pinDetailOverlay = document.getElementById('pinDetailOverlay');
            const closePinDetailButton = document.getElementById('closePinDetailButton');
            const pinDetailImage = document.getElementById('pinDetailImage');
            const pinDetailTitle = document.getElementById('pinDetailTitle');
            const pinDetailUploadedBy = document.getElementById('pinDetailUploadedBy');
            const pinDetailSourceDisplay = document.getElementById('pinDetailSourceDisplay'); // Updated ID
            const pinDetailDescription = document.getElementById('pinDetailDescription'); 
            const pinDetailSaveButton = document.getElementById('pinDetailSaveButton');
            const pinDetailDownloadButton = document.getElementById('pinDetailDownloadButton');

            function openPinDetail(pinData) {
                pinDetailImage.src = pinData.img;
                pinDetailImage.onerror = function() { 
                    this.onerror=null; 
                    this.src='https://placehold.co/500x750/e0e0e0/767676?text=Gambar+Tidak+Ditemukan';
                };
                pinDetailTitle.textContent = pinData.title || 'Tanpa Judul';
                pinDetailUploadedBy.textContent = pinData.uploadedBy || 'Anonim';
                
                // Show source only if available
                if (pinData.source) {
                    pinDetailSourceDisplay.innerHTML = `Sumber: <a href="http://${pinData.source}" target="_blank">${pinData.source}</a>`;
                    pinDetailSourceDisplay.style.display = 'block';
                } else {
                    pinDetailSourceDisplay.innerHTML = '';
                    pinDetailSourceDisplay.style.display = 'none';
                }

                // Show description only if available
                if (pinData.content) {
                    pinDetailDescription.textContent = pinData.content;
                    pinDetailDescription.style.display = 'block';
                } else {
                    pinDetailDescription.textContent = '';
                    pinDetailDescription.style.display = 'none';
                }

                // Update Save/Unsave Button state
                if (currentUser && currentUser.savedPins && currentUser.savedPins.includes(pinData.id)) {
                    pinDetailSaveButton.textContent = 'Disimpan';
                    pinDetailSaveButton.style.backgroundColor = '#767676';
                    pinDetailSaveButton.disabled = false; // Can now unsave
                    pinDetailSaveButton.onclick = async (e) => { // Attach unsave logic
                        e.stopPropagation(); 
                        const response = await makeApiRequest('pins.php?action=unsave', 'POST', { pinId: pinData.id });
                        if (response.success) {
                            showMessage('Pin berhasil dihapus dari daftar simpan!');
                            pinDetailSaveButton.textContent = 'Simpan';
                            pinDetailSaveButton.style.backgroundColor = '#e60023';
                            // Remove from currentUser.savedPins
                            if (currentUser.savedPins) {
                                currentUser.savedPins = currentUser.savedPins.filter(id => id !== pinData.id);
                            }
                            // Re-render pin grid if on 'Saved' tab
                            const currentTab = document.querySelector('.nav-button.active')?.dataset.nav;
                            if (currentTab === 'saved') {
                                loadedPinsCount = 0;
                                await loadPins(pinsPerPage, false);
                            }
                        } else {
                            showMessage('Gagal menghapus pin dari daftar simpan: ' + response.message, 'Error');
                        }
                    };
                } else {
                    pinDetailSaveButton.textContent = 'Simpan';
                    pinDetailSaveButton.style.backgroundColor = '#e60023';
                    pinDetailSaveButton.disabled = false;
                    pinDetailSaveButton.onclick = async (e) => { // Attach save logic
                        e.stopPropagation(); 
                        if (!currentUser) {
                            showMessage('Silakan login untuk menyimpan pin.', 'Login Diperlukan');
                            openLogin();
                            return;
                        }
                        const response = await makeApiRequest('pins.php?action=save', 'POST', { pinId: pinData.id });
                        if (response.success) {
                            showMessage('Pin berhasil disimpan!');
                            pinDetailSaveButton.textContent = 'Disimpan';
                            pinDetailSaveButton.style.backgroundColor = '#767676';
                            // Add to currentUser.savedPins
                            if (currentUser.savedPins) {
                                currentUser.savedPins.push(pinData.id);
                            } else {
                                currentUser.savedPins = [pinData.id];
                            }
                        } else {
                            showMessage('Gagal menyimpan pin: ' + response.message, 'Error');
                        }
                    };
                }

                pinDetailDownloadButton.onclick = (e) => { e.stopPropagation(); downloadPin(pinData.img); };

                pinDetailOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden'; // Mencegah scroll body

                // UPDATE URL for sharing
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('pin', pinData.id);
                history.pushState({ pinId: pinData.id }, '', newUrl.toString());
            }

            function closePinDetail() {
                pinDetailOverlay.style.display = 'none';
                document.body.style.overflow = ''; // Mengaktifkan kembali scroll body

                // Revert URL
                const currentUrl = new URL(window.location.href);
                if (currentUrl.searchParams.has('pin')) {
                    currentUrl.searchParams.delete('pin');
                    history.pushState(null, '', currentUrl.toString());
                }
            }

            closePinDetailButton.addEventListener('click', closePinDetail);

            // Handle browser back/forward for pin detail
            window.onpopstate = (event) => {
                const urlParams = new URLSearchParams(window.location.search);
                const pinIdFromUrl = urlParams.get('pin');
                if (pinIdFromUrl) {
                    // Try to find the pin in currently loaded pins data
                    const pinToOpen = allPinsData.find(pin => pin.id === pinIdFromUrl);
                    if (pinToOpen) {
                        openPinDetail(pinToOpen);
                    } else {
                        // If pin not found (e.g., page reloaded with specific pin URL),
                        // re-fetch all pins then try to open.
                        // Or, for simplicity, just close if not found in current data.
                        closePinDetail();
                    }
                } else {
                    closePinDetail();
                }
            };


            // --- Notification Overlay Logic ---
            const notificationOverlay = document.getElementById('notificationOverlay');
            const closeNotificationButton = document.getElementById('closeNotificationButton');
            const notificationListContainer = document.getElementById('notificationListContainer');

            async function openNotificationPage() {
                notificationListContainer.innerHTML = '<p style="text-align: center; color: #767676;">Memuat notifikasi...</p>';
                const response = await makeApiRequest('notifications.php?action=fetch_all');
                
                if (response.success && response.notifications.length > 0) {
                    notificationListContainer.innerHTML = ''; // Clear loading message
                    response.notifications.forEach(notif => {
                        const notifItem = document.createElement('div');
                        notifItem.classList.add('notification-item');
                        if (notif.read) {
                            notifItem.classList.add('read');
                        }
                        notifItem.innerHTML = `${notif.text} <span style="font-size:0.8em; color:#999; display:block; margin-top:5px;">(${notif.timestamp || 'Tanggal tidak diketahui'})</span>`;
                        notificationListContainer.appendChild(notifItem);
                    });
                    markAllNotificationsAsRead(); // Tandai semua sebagai sudah dibaca setelah ditampilkan
                } else {
                    notificationListContainer.innerHTML = '<p style="text-align: center; color: #767676;">Tidak ada notifikasi baru.</p>';
                }

                notificationOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            function closeNotificationPage() {
                notificationOverlay.style.display = 'none';
                document.body.style.overflow = '';
            }

            closeNotificationButton.addEventListener('click', closeNotificationPage);

            // --- Memuat Pin & Kategori ---
            const mainElement = document.querySelector('main');
            const pinGrid = document.getElementById('pinGrid');
            const loadingIndicator = document.getElementById('loading-indicator');
            let pinsPerPage = 20; 
            let loadedPinsCount = 0; 
            const categories = ["Untukmu", "Pakaian", "Dekorasi Rumah", "Resep", "DIY", "Kutipan", "Seni", "Perjalanan"];

            function createPinElement(pinData) {
                const pinDiv = document.createElement('div');
                pinDiv.classList.add('pin');
                pinDiv.dataset.id = pinData.id;

                const img = document.createElement('img');
                img.src = pinData.img;
                img.alt = 'Gambar Pin';
                img.onerror = function() { 
                    this.onerror=null; 
                    this.src='https://placehold.co/236x300/e0e0e0/767676?text=Gambar+Tidak+Ditemukan';
                };

                const overlayDiv = document.createElement('div');
                overlayDiv.classList.add('pin-overlay');
                
                const overlayTop = document.createElement('div');
                overlayTop.classList.add('pin-overlay-top');
                
                const saveButton = document.createElement('button');
                saveButton.classList.add('pin-save-button');
                
                if (currentUser && currentUser.savedPins && currentUser.savedPins.includes(pinData.id)) {
                    saveButton.textContent = 'Disimpan';
                    saveButton.style.backgroundColor = '#767676';
                    saveButton.disabled = true;
                } else {
                    saveButton.textContent = 'Simpan';
                    saveButton.style.backgroundColor = '#e60023';
                    saveButton.disabled = false;
                }
                
                saveButton.onclick = async (e) => { 
                    e.stopPropagation(); 
                    if (!currentUser) {
                        showMessage('Silakan login untuk menyimpan pin.', 'Login Diperlukan');
                        openLogin();
                        return;
                    }

                    const response = await makeApiRequest('pins.php?action=save', 'POST', { pinId: pinData.id });
                    if (response.success) {
                        showMessage('Pin berhasil disimpan!');
                        saveButton.textContent = 'Disimpan';
                        saveButton.style.backgroundColor = '#767676';
                        saveButton.disabled = true;
                        if (currentUser.savedPins) {
                             currentUser.savedPins.push(pinData.id);
                        } else {
                            currentUser.savedPins = [pinData.id];
                        }
                    } else {
                        showMessage('Gagal menyimpan pin: ' + response.message, 'Error');
                    }
                };
                overlayTop.appendChild(saveButton);

                const overlayBottom = document.createElement('div');
                overlayBottom.classList.add('pin-overlay-bottom');

                const pinTitle = document.createElement('div'); 
                pinTitle.classList.add('pin-title');
                pinTitle.textContent = pinData.title || 'No Title'; 
                overlayBottom.appendChild(pinTitle);

                const infoDiv = document.createElement('div');
                infoDiv.classList.add('pin-info');
                // Display source only if available in thumbnail view
                if (pinData.source) {
                    const link = document.createElement('a');
                    link.href = `http://${pinData.source}`;
                    link.target = '_blank';
                    link.textContent = pinData.source;
                    link.onclick = (e) => e.stopPropagation(); 
                    infoDiv.appendChild(link);
                } else {
                    infoDiv.textContent = 'Tanpa Sumber';
                    infoDiv.style.opacity = '0.7'; // Reduce opacity for optional info
                }
                overlayBottom.appendChild(infoDiv);

                const bottomActions = document.createElement('div'); 
                bottomActions.classList.add('pin-bottom-actions');
                
                const downloadButton = document.createElement('button');
                downloadButton.classList.add('pin-action-icon');
                downloadButton.innerHTML = `<svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>`;
                downloadButton.onclick = (e) => { e.stopPropagation(); downloadPin(pinData.img); };
                
                // Add the download button (aligned with source display area)
                bottomActions.appendChild(downloadButton);
                overlayBottom.appendChild(bottomActions); 
                
                overlayDiv.appendChild(overlayTop);
                overlayDiv.appendChild(overlayBottom);

                pinDiv.appendChild(img);
                pinDiv.appendChild(overlayDiv);
                
                pinDiv.onclick = () => openPinDetail(pinData);
                
                return pinDiv;
            }

            async function loadPins(count, append = true) {
                loadingIndicator.style.display = 'block';
                const currentTab = document.querySelector('.nav-button.active')?.dataset.nav;
                let endpoint = '';
                let params = '';

                if (currentSearchQuery) { 
                    endpoint = 'pins.php?action=search';
                    params = `&query=${encodeURIComponent(currentSearchQuery)}`;
                } else if (currentTab === 'saved') {
                    if (!currentUser) {
                        pinGrid.innerHTML = '<p style="text-align: center; color: #767676; margin-top: 50px;">Silakan login untuk melihat pin yang Anda simpan.</p>';
                        loadingIndicator.style.display = 'none';
                        return;
                    }
                    endpoint = 'pins.php?action=fetch_saved';
                } else {
                    endpoint = 'pins.php?action=fetch_all';
                }

                const response = await makeApiRequest(`${endpoint}${params}`);
                loadingIndicator.style.display = 'none';

                if (response.success) {
                    // Update allPinsData only if fetching all or search results
                    if (!currentTab || currentTab === 'home' || currentSearchQuery) {
                       allPinsData = response.pins || []; 
                    } else if (currentTab === 'saved') {
                        // For 'saved' tab, only update local savedPins for user, not global allPinsData
                        // unless specifically needed for popstate to find the pin by ID.
                        // For popstate to work correctly, allPinsData should ideally contain all accessible pins.
                        // For now, we assume allPinsData is primarily for popstate and search context.
                    }

                    const pinsToDisplay = response.pins || [];
                    
                    const startIndex = append ? loadedPinsCount : 0;
                    const slicedPinsToDisplay = pinsToDisplay.slice(startIndex, startIndex + count);

                    if (!append) {
                        pinGrid.innerHTML = '';
                        loadedPinsCount = 0;
                    }

                    const fragment = document.createDocumentFragment();
                    slicedPinsToDisplay.forEach(pinData => {
                        const pinElement = createPinElement(pinData);
                        fragment.appendChild(pinElement);
                        loadedPinsCount++;
                    });
                    pinGrid.appendChild(fragment);

                    if (slicedPinsToDisplay.length === 0 && loadedPinsCount === 0) {
                        if (currentSearchQuery) {
                            pinGrid.innerHTML = `<p style="text-align: center; color: #767676; margin-top: 50px;">Tidak ada pin ditemukan untuk "${currentSearchQuery}".</p>`;
                        } else {
                            pinGrid.innerHTML = '<p style="text-align: center; color: #767676; margin-top: 50px;">Tidak ada pin untuk ditampilkan.</p>';
                        }
                    }
                } else {
                    showMessage('Gagal memuat pin: ' + response.message, 'Error');
                    pinGrid.innerHTML = '<p style="text-align: center; color: #e60023; margin-top: 50px;">Error saat memuat pin. Silakan coba lagi nanti.</p>';
                }
            }

            // --- Search Suggestions Logic ---
            const mobileSearchInputOverlay = document.getElementById('mobileSearchInputOverlay'); 
            const desktopSearchInput = document.getElementById('desktopSearchInput');
            const searchSuggestionsListMobile = document.getElementById('searchSuggestions');
            const searchSuggestionsListDesktop = document.getElementById('desktopSearchSuggestions');
            const searchResultsContainer = document.getElementById('searchResults');
            const searchLoadingIndicator = document.getElementById('searchLoadingIndicator');
            const categoryExploreTitle = document.getElementById('categoryExploreTitle');
            const categoryGridMobile = document.getElementById('categoryGridMobile');

            let searchTimeout;

            function showSuggestions(inputElement, suggestionsList, query) {
                suggestionsList.innerHTML = ''; // Clear previous suggestions
                if (query.length < 2) { // Start suggesting after 2 characters
                    suggestionsList.style.display = 'none';
                    searchResultsContainer.style.display = 'none';
                    categoryExploreTitle.style.display = 'block';
                    categoryGridMobile.style.display = 'grid'; // Show categories if no search/suggestions
                    return;
                }

                const filteredSuggestions = allPinsData.filter(pin => 
                    pin.title.toLowerCase().includes(query.toLowerCase()) ||
                    (pin.source && pin.source.toLowerCase().includes(query.toLowerCase())) ||
                    (pin.content && pin.content.toLowerCase().includes(query.toLowerCase()))
                ).map(pin => pin.title).slice(0, 5); // Limit to 5 suggestions, just titles for simplicity

                const uniqueSuggestions = [...new Set(filteredSuggestions)]; // Get unique titles

                if (uniqueSuggestions.length > 0) {
                    uniqueSuggestions.forEach(suggestion => {
                        const listItem = document.createElement('li');
                        listItem.textContent = suggestion;
                        listItem.addEventListener('click', () => {
                            inputElement.value = suggestion;
                            performSearch(suggestion);
                            suggestionsList.style.display = 'none';
                        });
                        suggestionsList.appendChild(listItem);
                    });
                    suggestionsList.style.display = 'block';
                    searchResultsContainer.style.display = 'none'; // Hide results while suggestions are active
                    categoryExploreTitle.style.display = 'none'; // Hide categories
                    categoryGridMobile.style.display = 'none';
                } else {
                    suggestionsList.style.display = 'none';
                    // If no suggestions, still ready for direct search or show categories
                    searchResultsContainer.style.display = 'none';
                    categoryExploreTitle.style.display = 'block';
                    categoryGridMobile.style.display = 'grid';
                }
            }

            async function performSearch(query) {
                searchLoadingIndicator.style.display = 'block';
                searchSuggestionsListMobile.style.display = 'none';
                searchSuggestionsListDesktop.style.display = 'none';
                searchResultsContainer.innerHTML = ''; // Clear previous results
                searchResultsContainer.style.display = 'block';
                categoryExploreTitle.style.display = 'none';
                categoryGridMobile.style.display = 'none';

                const response = await makeApiRequest(`pins.php?action=search&query=${encodeURIComponent(query)}`);
                searchLoadingIndicator.style.display = 'none';

                if (response.success && response.pins.length > 0) {
                    response.pins.forEach(pinData => {
                        searchResultsContainer.appendChild(createPinElement(pinData));
                    });
                } else {
                    searchResultsContainer.innerHTML = `<p style="text-align: center; color: #767676; margin-top: 20px;">Tidak ada hasil ditemukan untuk "${query}".</p>`;
                }
            }

            // Mobile search input listener
            mobileSearchInputOverlay.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    showSuggestions(mobileSearchInputOverlay, searchSuggestionsListMobile, e.target.value.trim());
                }, 300); // Debounce
            });

            mobileSearchInputOverlay.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent form submission
                    const query = mobileSearchInputOverlay.value.trim();
                    if (query) {
                        performSearch(query);
                    }
                }
            });

            // Desktop search input listener
            desktopSearchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    showSuggestions(desktopSearchInput, searchSuggestionsListDesktop, e.target.value.trim());
                }, 300); // Debounce
            });

            desktopSearchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); // Prevent form submission
                    const query = desktopSearchInput.value.trim();
                    if (query) {
                        mainElement.classList.remove('desktop-search-active'); // Close category section
                        // If desktop search, just load pins into main grid for now
                        // If you want desktop search to behave like mobile search (staying in an overlay/section),
                        // you'd need a separate overlay for desktop search too.
                        // For this revision, desktop search will still show results on main grid.
                        currentSearchQuery = query;
                        loadedPinsCount = 0;
                        loadPins(pinsPerPage, false);
                    }
                }
            });
            
            // Handle clicks outside search suggestions to hide them
            document.addEventListener('click', (event) => {
                const isClickInsideDesktopSearch = desktopSearchInput.parentElement.contains(event.target) || searchSuggestionsListDesktop.contains(event.target);
                if (!isClickInsideDesktopSearch) {
                    searchSuggestionsListDesktop.style.display = 'none';
                }
                const isClickInsideMobileSearchOverlay = searchOverlay.contains(event.target);
                if (!isClickInsideMobileSearchOverlay && searchOverlay.style.display === 'flex') {
                    // If search overlay is open and clicked outside, close it.
                    // This is handled by closeSearchBtn as well, but this catches clicks directly on the dimmed background.
                    // Or, if search overlay stays open, just hide suggestions.
                    searchSuggestionsListMobile.style.display = 'none';
                }
            });


            function loadCategories() {
                const categoryContainers = [
                    document.getElementById('categoryGridMobile'),
                    document.getElementById('categoryGridDesktop')
                ];

                categoryContainers.forEach(container => {
                    if (!container) return; 
                    
                    container.innerHTML = ''; 
                    const fragment = document.createDocumentFragment();

                    categories.forEach((cat) => {
                        const catItem = document.createElement('div');
                        catItem.className = 'category-item';
                        
                        const imageUrl = `https://picsum.photos/200/200?random=${Math.random()}`;
                        catItem.style.backgroundImage = `url('${imageUrl}')`;

                        const catTitle = document.createElement('span');
                        catTitle.textContent = cat;
                        
                        catItem.appendChild(catTitle);
                        
                        catItem.onclick = function() {
                            currentSearchQuery = cat; 
                            if (this.closest('#searchOverlay')) { // If clicked in mobile search overlay
                                performSearch(cat); // Perform search and stay in search section
                            } else { // If clicked in desktop category section
                                mainElement.classList.remove('desktop-search-active'); // Close desktop category section
                                loadedPinsCount = 0; 
                                loadPins(pinsPerPage, false);
                            }
                        };
                        fragment.appendChild(catItem);
                    });
                    container.appendChild(fragment);
                });
            }
            
            loadCategories();

            // --- Infinite Scroll ---
            window.addEventListener('scroll', () => {
                if (loadingIndicator.style.display === 'none' && 
                    searchOverlay.style.display === 'none' && 
                    loginOverlay.style.display === 'none' &&
                    addPinOverlay.style.display === 'none' &&
                    mobileProfileDropdown.style.display === 'none' &&
                    pinDetailOverlay.style.display === 'none' && 
                    notificationOverlay.style.display === 'none' 
                ) {
                    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 400) {
                        // Only load more if not in search results view or if current tab is home/saved
                        const currentTab = document.querySelector('.nav-button.active')?.dataset.nav;
                        if (!currentSearchQuery && (currentTab === 'home' || currentTab === 'saved')) {
                            loadPins(pinsPerPage, true);
                        }
                    }
                }
            });

            // --- Interaksi Pencarian/Kategori Desktop ---
            const desktopCategories = document.querySelector('.desktop-categories');
            
            desktopSearchInput.addEventListener('focus', () => {
                mainElement.classList.add('desktop-search-active');
                // Hide main content pin grid when desktop search is focused
                pinGrid.style.display = 'none'; 
                loadingIndicator.style.display = 'none';
            });
            
            // Handle closing desktop search/categories
            document.addEventListener('click', (event) => {
                const isClickInsideHeaderSearch = desktopSearchInput.parentElement.contains(event.target);
                const isClickInsideDesktopCategories = desktopCategories.contains(event.target);
                
                if (!isClickInsideHeaderSearch && !isClickInsideDesktopCategories) {
                   mainElement.classList.remove('desktop-search-active');
                   // Show main content pin grid again when clicking outside
                   pinGrid.style.display = 'column'; 
                   loadPins(pinsPerPage, false); // Reload main pins
                }
            });

            // --- Logika Tombol Header ---
            const headerNavButtons = document.querySelectorAll('.header-nav-links .nav-button');
            const desktopCreateButton = document.getElementById('desktopCreateButton');

            desktopCreateButton.addEventListener('click', async function() {
                if (!currentUser) {
                    showMessage('Silakan login untuk membuat pin.', 'Login Diperlukan');
                    headerNavButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelector('.nav-button[data-nav="home"]').classList.add('active');
                    openLogin();
                    return;
                }
                openAddPinOverlay();
            });

            headerNavButtons.forEach(button => {
                if (button.id === 'desktopCreateButton') return; 

                button.addEventListener('click', async function() {
                    headerNavButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    const navAction = this.dataset.nav;
                    currentSearchQuery = ''; // Clear search on tab change

                    // Ensure main pin grid is visible and search results are hidden
                    pinGrid.style.display = 'column'; 
                    searchResultsContainer.style.display = 'none';
                    searchLoadingIndicator.style.display = 'none';


                    if (navAction === 'home') {
                        loadedPinsCount = 0;
                        await loadPins(pinsPerPage, false);
                    } else if (navAction === 'saved') {
                        if (!currentUser) {
                            showMessage('Silakan login untuk melihat pin yang Anda simpan.', 'Login Diperlukan');
                            headerNavButtons.forEach(btn => btn.classList.remove('active'));
                            document.querySelector('.nav-button[data-nav="home"]').classList.add('active');
                            return;
                        }
                        loadedPinsCount = 0;
                        await loadPins(pinsPerPage, false);
                    }
                });
            });


            // --- Mobile Search Overlay Logic ---
            const searchOverlay = document.getElementById('searchOverlay');
            const closeSearchBtn = document.getElementById('closeSearchOverlay');
            
            const openSearch = () => {
                searchOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                // Reset search overlay state when opened
                mobileSearchInputOverlay.value = '';
                searchSuggestionsListMobile.innerHTML = '';
                searchSuggestionsListMobile.style.display = 'none';
                searchResultsContainer.innerHTML = '';
                searchResultsContainer.style.display = 'none';
                searchLoadingIndicator.style.display = 'none';
                categoryExploreTitle.style.display = 'block';
                categoryGridMobile.style.display = 'grid';
            };
            
            const closeSearch = () => {
                searchOverlay.style.display = 'none';
                document.body.style.overflow = '';
            };

            closeSearchBtn.onclick = closeSearch;
            
            mobileSearchInputOverlay.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    const query = mobileSearchInputOverlay.value.trim();
                    if (query) {
                        performSearch(query); // Perform search and stay in search overlay
                    }
                }
            });

            // --- Logika Navigasi Mobile ---
            const mobileNavItems = document.querySelectorAll('.mobile-bottom-nav .mobile-nav-item');
            mobileNavItems.forEach(item => {
                item.addEventListener('click', async function() {
                    const action = this.dataset.action;

                    // Ensure all overlays are closed when changing main navigation
                    closePinDetail();
                    closeNotificationPage();
                    closeSearch();
                    
                    if (action === 'search') {
                        openSearch();
                    } else if (action === 'create-pin') { 
                         if (!currentUser) {
                            showMessage('Silakan login untuk membuat pin.', 'Login Diperlukan');
                            return;
                        }
                        openAddPinOverlay();
                    }
                    else if (action === 'profile') { 
                        if (!currentUser) {
                            showMessage('Silakan login untuk melihat profil Anda.', 'Login Diperlukan');
                            openLogin();
                            return;
                        }
                        if (currentUser.isAdmin) {
                            window.location.href = 'admin.php';
                        } else {
                            window.location.href = 'user.php';
                        }
                    }
                    else { 
                        mobileNavItems.forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        if (action === 'home' || action === 'saved') { 
                            const desktopButton = document.querySelector(`.header-nav-links .nav-button[data-nav="${action}"]`);
                            if (desktopButton) {
                                headerNavButtons.forEach(btn => btn.classList.remove('active'));
                                desktopButton.classList.add('active');
                            }
                        }
                        currentSearchQuery = ''; 
                        pinGrid.style.display = 'column'; // Ensure main pin grid is visible
                        searchResultsContainer.style.display = 'none'; // Hide search results
                        searchLoadingIndicator.style.display = 'none';


                        if (action === 'home') {
                            loadedPinsCount = 0;
                            await loadPins(pinsPerPage, false);
                        } else if (action === 'saved') { 
                            if (!currentUser) {
                                showMessage('Silakan login untuk melihat pin yang Anda simpan.', 'Login Diperlukan');
                                mobileNavItems.forEach(i => i.classList.remove('active'));
                                document.querySelector('.mobile-nav-item[data-action="home"]').classList.add('active');
                                return;
                            }
                            loadedPinsCount = 0;
                            await loadPins(pinsPerPage, false);
                        }
                    }
                });
            });

            // --- Logika Overlay Login/Daftar ---
            const loginOverlay = document.getElementById('loginOverlay');
            const closeLoginBtn = document.getElementById('closeLoginOverlay');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const showRegisterBtn = document.getElementById('showRegister');
            const showLoginBtn = document.getElementById('showLogin');
            const loginAsAdminBtn = document.getElementById('loginAsAdmin');

            const profileButton = document.getElementById('profileButton');
            const profileIconLetter = document.getElementById('profileIconLetter');

            function openLogin() {
                loginOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                loginForm.style.display = 'flex';
                registerForm.style.display = 'none';
            }

            function closeLogin() {
                loginOverlay.style.display = 'none';
                document.body.style.overflow = '';
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerPassword').value = '';
            }

            profileButton.addEventListener('click', () => {
                if (!currentUser) {
                    openLogin();
                } else {
                    if (currentUser.isAdmin) {
                        window.location.href = 'admin.php';
                    } else {
                        window.location.href = 'user.php';
                    }
                }
            });

            closeLoginBtn.onclick = closeLogin;

            showRegisterBtn.onclick = (e) => {
                e.preventDefault();
                loginForm.style.display = 'none';
                registerForm.style.display = 'flex';
            };

            showLoginBtn.onclick = (e) => {
                e.preventDefault();
                registerForm.style.display = 'none';
                loginForm.style.display = 'flex';
            };

            loginAsAdminBtn.onclick = (e) => {
                e.preventDefault();
                document.getElementById('loginUsername').value = 'admin';
                document.getElementById('loginPassword').value = 'password123';
                loginForm.dispatchEvent(new Event('submit'));
            };

            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value;
                const password = document.getElementById('loginPassword').value;
                
                const response = await makeApiRequest('auth.php?action=login', 'POST', { username, password });

                if (response.success) {
                    currentUser = response.user;
                    const savedResponse = await makeApiRequest(`pins.php?action=fetch_saved`);
                    if (savedResponse.success) {
                        currentUser.savedPins = savedResponse.pins.map(pin => pin.id);
                    } else {
                        currentUser.savedPins = [];
                    }

                    showMessage(`Selamat datang kembali, ${currentUser.username}!`, 'Login Berhasil');
                    updateProfileDisplay();
                    updateHeaderDropdown();
                    updateNotificationBadge();
                    closeLogin();
                    loadedPinsCount = 0;
                    await loadPins(pinsPerPage, false);
                } else {
                    showMessage('Login gagal: ' + response.message, 'Login Gagal');
                }
            });

            registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('registerUsername').value;
                const password = document.getElementById('registerPassword').value;

                const response = await makeApiRequest('auth.php?action=register', 'POST', { username, password });
                
                if (response.success) {
                    showMessage('Registrasi berhasil! Anda sekarang bisa login.', 'Registrasi Berhasil');
                    loginForm.style.display = 'flex';
                    registerForm.style.display = 'none';
                } else {
                    showMessage('Registrasi gagal: ' + response.message, 'Registrasi Gagal');
                }
            });

            // --- Tampilan Profil Pengguna & Dropdown Header ---
            function updateProfileDisplay() {
                const mobileProfileIcon = document.querySelector('.mobile-nav-item[data-action="profile"] .profile-icon');
                if (currentUser) {
                    profileIconLetter.textContent = currentUser.username.charAt(0).toUpperCase();
                    profileIconLetter.style.backgroundColor = '#e60023';
                    profileIconLetter.style.color = 'white';

                    if (mobileProfileIcon) {
                        mobileProfileIcon.textContent = currentUser.username.charAt(0).toUpperCase();
                        mobileProfileIcon.style.backgroundColor = '#fff';
                        mobileProfileIcon.style.color = '#111';
                    }
                } else {
                    profileIconLetter.textContent = 'G';
                    profileIconLetter.style.backgroundColor = '#ddd';
                    profileIconLetter.style.color = '#767676';

                    if (mobileProfileIcon) {
                        mobileProfileIcon.textContent = 'G';
                        mobileProfileIcon.style.backgroundColor = '#e0e0e0';
                        mobileProfileIcon.style.color = '#333';
                    }
                }
            }

            const notificationButton = document.getElementById('notificationButton');
            const mobileNotificationButton = document.getElementById('mobileNotificationButton');
            const notificationBadge = document.getElementById('notificationBadge');
            const mobileNotificationBadge = document.getElementById('mobileNotificationBadge');

            async function updateNotificationBadge() {
                try {
                    const response = await makeApiRequest('notifications.php?action=fetch_all');
                    if (response.success) {
                        const notifications = response.notifications || [];
                        const unreadCount = notifications.filter(notif => !notif.read).length; 
                        
                        if (unreadCount > 0) {
                            notificationBadge.textContent = unreadCount;
                            notificationBadge.style.display = 'flex';
                            mobileNotificationBadge.textContent = unreadCount;
                            mobileNotificationBadge.style.display = 'flex';
                        } else {
                            notificationBadge.style.display = 'none';
                            mobileNotificationBadge.style.display = 'none';
                        }
                    }
                } catch (error) {
                    console.error('Failed to update notification badge:', error);
                }
            }

            async function markAllNotificationsAsRead() {
                try {
                    const response = await makeApiRequest('notifications.php?action=mark_as_read', 'POST', null); 
                    if (response.success) {
                        updateNotificationBadge();
                    }
                } catch (error) {
                    console.error('Failed to mark notifications as read:', error);
                }
            }

            notificationButton.addEventListener('click', openNotificationPage);
            mobileNotificationButton.addEventListener('click', openNotificationPage);


            // --- Pin Functions (Download) ---
            function downloadPin(imageUrl) {
                const link = document.createElement('a');
                link.href = imageUrl;
                const filename = imageUrl.substring(imageUrl.lastIndexOf('/') + 1) || 'pin_image.jpg';
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage(`Mengunduh pin.`);
            }

            // --- Add Pin Overlay ---
            const addPinOverlay = document.getElementById('addPinOverlay');
            const closeAddPinOverlayBtn = document.getElementById('closeAddPinOverlay');
            const addPinForm = document.getElementById('addPinForm');
            const newPinTitle = document.getElementById('newPinTitle'); 
            const newPinContent = document.getElementById('newPinContent'); // Get content textarea

            function openAddPinOverlay() {
                addPinOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            function closeAddPinOverlay() {
                addPinOverlay.style.display = 'none';
                document.body.style.overflow = '';
                addPinForm.reset();
            }

            closeAddPinOverlayBtn.onclick = closeAddPinOverlay;

            addPinForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const title = newPinTitle.value.trim(); 
                const content = newPinContent.value.trim(); 
                const imageUrl = document.getElementById('newPinImageURL').value.trim();
                const source = document.getElementById('newPinSource').value.trim(); // Get source

                if (!title || !imageUrl) { // Title and image URL are required
                    showMessage('Judul dan URL gambar harus diisi.', 'Input Dibutuhkan');
                    return;
                }

                const response = await makeApiRequest('pins.php?action=add', 'POST', { title, content, imageUrl, source }); 
                if (response.success) {
                    showMessage('Pin berhasil diunggah!', 'Sukses!');
                    closeAddPinOverlay();
                    loadedPinsCount = 0;
                    await loadPins(pinsPerPage, false);
                } else {
                    showMessage('Gagal mengunggah pin: ' + response.message, 'Error!');
                }
            });


            // --- Desktop More Accounts Dropdown ---
            const moreAccountsButton = document.getElementById('moreAccountsButton');
            const moreAccountsDropdown = document.getElementById('moreAccountsDropdown');
            const dropdownUsernameDisplay = document.getElementById('dropdownUsernameDisplay');
            const dropdownMyProfile = document.getElementById('dropdownMyProfile');
            const dropdownAdminPanel = document.getElementById('dropdownAdminPanel');
            const dropdownLogout = document.getElementById('dropdownLogout');

            function toggleDropdown() {
                updateHeaderDropdown();
                moreAccountsDropdown.style.display = moreAccountsDropdown.style.display === 'block' ? 'none' : 'block';
            }

            function updateHeaderDropdown() {
                if (currentUser) {
                    dropdownUsernameDisplay.textContent = `Login sebagai ${currentUser.username}`;
                    dropdownMyProfile.style.display = 'block';
                    dropdownAdminPanel.style.display = currentUser.isAdmin ? 'block' : 'none';
                    dropdownLogout.style.display = 'block';
                } else {
                    dropdownUsernameDisplay.textContent = 'Selamat Datang, Tamu!';
                    dropdownMyProfile.style.display = 'none';
                    dropdownAdminPanel.style.display = 'none';
                    dropdownLogout.style.display = 'none';
                }
            }

            moreAccountsButton.addEventListener('click', toggleDropdown);

            document.addEventListener('click', function(event) {
                if (!moreAccountsButton.contains(event.target) && !moreAccountsDropdown.contains(event.target)) {
                    moreAccountsDropdown.style.display = 'none';
                }
            });

            dropdownMyProfile.addEventListener('click', () => {
                if (currentUser) {
                    window.location.href = 'user.php';
                }
                moreAccountsDropdown.style.display = 'none';
            });

            dropdownAdminPanel.addEventListener('click', () => {
                if (currentUser && currentUser.isAdmin) {
                    window.location.href = 'admin.php';
                } else {
                    showMessage('Akses ditolak: Diperlukan hak akses administrator.', 'Error');
                }
                moreAccountsDropdown.style.display = 'none';
            });

            dropdownLogout.addEventListener('click', async () => {
                const response = await makeApiRequest('auth.php?action=logout', 'POST', null); 
                if (response.success) {
                    currentUser = null;
                    updateProfileDisplay();
                    updateHeaderDropdown();
                    showMessage('Logout berhasil.', 'Logout');
                    loadedPinsCount = 0;
                    currentSearchQuery = ''; 
                    await loadPins(pinsPerPage, false);
                    headerNavButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelector('.nav-button[data-nav="home"]').classList.add('active');
                } else {
                    showMessage('Logout gagal: ' + response.message, 'Error');
                }
                moreAccountsDropdown.style.display = 'none';
            });

            // Mobile Profile Options (for mobile bottom nav profile icon)
            const mobileProfileDropdown = document.getElementById('mobileProfileDropdown');
            const mobileDropdownUsernameDisplay = document.getElementById('mobileDropdownUsernameDisplay');
            const mobileDropdownMyProfile = document.getElementById('mobileDropdownMyProfile');
            const mobileDropdownAdminPanel = document.getElementById('mobileDropdownAdminPanel');
            const mobileDropdownLogout = document.getElementById('mobileDropdownLogout');
            const mobileDropdownClose = document.getElementById('mobileDropdownClose');

            function showMobileProfileOptions() {
                if (!currentUser) return;

                mobileDropdownUsernameDisplay.textContent = `Login sebagai ${currentUser.username}`;
                mobileDropdownMyProfile.style.display = 'block';
                mobileDropdownAdminPanel.style.display = currentUser.isAdmin ? 'block' : 'none';
                
                mobileProfileDropdown.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            mobileDropdownMyProfile.addEventListener('click', () => {
                if (currentUser) {
                    window.location.href = 'user.php';
                }
                mobileProfileDropdown.style.display = 'none';
                document.body.style.overflow = '';
            });

            mobileDropdownAdminPanel.addEventListener('click', () => {
                if (currentUser && currentUser.isAdmin) {
                    window.location.href = 'admin.php';
                } else {
                    showMessage('Akses ditolak: Diperlukan hak akses administrator.', 'Error');
                }
                mobileProfileDropdown.style.display = 'none';
                document.body.style.overflow = '';
            });

            mobileDropdownLogout.addEventListener('click', async () => {
                const response = await makeApiRequest('auth.php?action=logout', 'POST', null); 
                if (response.success) {
                    currentUser = null;
                    updateProfileDisplay();
                    updateHeaderDropdown();
                    showMessage('Logout berhasil.', 'Logout');
                    loadedPinsCount = 0;
                    currentSearchQuery = ''; 
                    await loadPins(pinsPerPage, false);
                    mobileNavItems.forEach(i => i.classList.remove('active'));
                    document.querySelector('.mobile-nav-item[data-action="home"]').classList.add('active');
                    headerNavButtons.forEach(btn => btn.classList.remove('active'));
                    document.querySelector('.nav-button[data-nav="home"]').classList.add('active');
                } else {
                    showMessage('Logout gagal: ' + response.message, 'Error');
                }
                mobileProfileDropdown.style.display = 'none';
                document.body.style.overflow = '';
            });

            mobileDropdownClose.addEventListener('click', () => {
                mobileProfileDropdown.style.display = 'none';
                document.body.style.overflow = '';
            });

            // --- Cek Sesi Awal dan Muat ---
            async function initializeApp() {
                const response = await makeApiRequest('auth.php?action=check_session');
                if (response.success && response.user) {
                    currentUser = response.user;
                    const savedResponse = await makeApiRequest(`pins.php?action=fetch_saved`);
                    if (savedResponse.success) {
                        currentUser.savedPins = savedResponse.pins.map(pin => pin.id);
                    } else {
                        currentUser.savedPins = [];
                    }
                } else {
                    currentUser = null;
                }
                updateProfileDisplay();
                updateHeaderDropdown();
                updateNotificationBadge();
                
                // Always load all pins initially to populate allPinsData for search and URL handling
                const allPinsResponse = await makeApiRequest('pins.php?action=fetch_all');
                if (allPinsResponse.success) {
                    allPinsData = allPinsResponse.pins;
                } else {
                    // Handle error if initial pins load fails
                    console.error("Failed to load all pins on init:", allPinsResponse.message);
                }

                // Load pins to display on main grid (could be a subset of allPinsData)
                await loadPins(pinsPerPage, false);

                // Check URL for pin detail on initial load AFTER allPinsData is populated
                const urlParams = new URLSearchParams(window.location.search);
                const pinIdFromUrl = urlParams.get('pin');
                if (pinIdFromUrl) {
                    const pinToOpen = allPinsData.find(pin => pin.id === pinIdFromUrl);
                    if (pinToOpen) {
                        openPinDetail(pinToOpen);
                    } else {
                        // If pin not found in fetched data, remove the parameter from URL
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.delete('pin');
                        history.replaceState(null, '', currentUrl.toString());
                    }
                }
            }

            initializeApp();
        });
    </script>
</body>
</html>