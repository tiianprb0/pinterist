<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spicette</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* Gaya CSS inline telah dipindahkan ke style.css */
        /* NEW: Gaya untuk tombol tautan notifikasi */
        .notification-link-button {
            background-color: #f0f2f5; /* Latar belakang abu-abu terang */
            color: #1a1a1a; /* Teks gelap */
            border: 1px solid #ebebeb; /* Border tipis */
            padding: 8px 14px;
            border-radius: 20px; /* Lebih rounded */
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600; /* Lebih tebal */
            margin-top: 10px;
            display: inline-flex; /* Menggunakan flex untuk ikon dan teks */
            align-items: center;
            gap: 8px; /* Jarak antara ikon dan teks */
            transition: all 0.2s ease; /* Transisi untuk hover */
            text-decoration: none; /* Menghilangkan garis bawah default untuk tautan */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* Bayangan sangat tipis */
        }
        .notification-link-button:hover {
            background-color: #e0e0e0; /* Sedikit lebih gelap saat hover */
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); /* Bayangan sedikit lebih terlihat */
            transform: translateY(-1px); /* Efek angkat sedikit */
        }
        .notification-link-button i {
            color: #6a6a6a; /* Warna ikon sekunder */
            transition: color 0.2s ease;
        }
        .notification-link-button:hover i {
            color: #1a1a1a; /* Warna ikon lebih gelap saat hover */
        }

        /* Gaya untuk tombol like baru - Lebih Minimalis */
        .pin-like-section {
            display: flex;
            align-items: center;
            gap: 10px; /* Kurangi jarak */
            margin-top: 15px; /* Kurangi margin atas */
            padding-top: 10px; /* Kurangi padding atas */
            border-top: none; /* Hapus garis pemisah */
        }

        .like-status-text {
            font-size: 0.9em; /* Ukuran font lebih kecil */
            color: #767676; /* Warna lebih terang */
            font-weight: 400; /* Lebih tipis */
        }

        .like-button {
            background-color: #f0f0f0; /* Warna abu-abu sangat terang */
            color: #1a1a1a; /* Teks gelap */
            border: 1px solid #e0e0e0; /* Border tipis */
            padding: 8px 15px; /* Kurangi padding */
            border-radius: 20px; /* Lebih bulat */
            cursor: pointer;
            font-size: 0.9em; /* Ukuran font lebih kecil */
            font-weight: 600; /* Lebih tebal */
            display: inline-flex;
            align-items: center;
            gap: 6px; /* Kurangi jarak ikon */
            transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: none; /* Hapus bayangan */
        }

        .like-button.liked {
            background-color: #e60023; /* Warna merah Pinterest saat disukai */
            color: white; /* Teks putih saat disukai */
            border-color: #e60023; /* Border merah saat disukai */
        }

        .like-button:hover {
            background-color: #e0e0e0; /* Sedikit lebih gelap saat hover */
            transform: translateY(-1px);
            box-shadow: 0 1px 4px rgba(0,0,0,0.1); /* Bayangan sangat tipis saat hover */
        }
        .like-button.liked:hover {
            background-color: #ad081b; /* Merah lebih gelap saat hover dan disukai */
        }

        .like-button i {
            font-size: 1em; /* Ukuran ikon sedikit lebih kecil */
        }

        /* NEW: CSS untuk blur dan overlay pin */
        .pin-blurred img {
            filter: blur(3px); /* Efek blur samar */
            transition: filter 0.3s ease;
        }

        .pin-overlay-restricted {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.3); /* Overlay gelap transparan */
            display: flex;
            flex-direction: column; /* Untuk menumpuk teks dan link */
            justify-content: center;
            align-items: center;
            opacity: 0; /* Awalnya tersembunyi */
            transition: opacity 0.3s ease;
            pointer-events: none; /* Memungkinkan klik di bawah overlay */
            border-radius: 16px; /* Sesuai dengan pin */
            overflow: hidden; /* Pastikan blur tidak meluber */
            text-align: center;
            padding: 10px;
            box-sizing: border-box;
        }

        .pin-blurred .pin-overlay-restricted {
            opacity: 1; /* Tampilkan overlay saat pin diburamkan */
            pointer-events: auto; /* Aktifkan pointer events saat overlay terlihat */
        }

        .pin-restricted-text {
            color: white;
            font-weight: bold;
            font-size: 0.9em; /* Ukuran font kecil */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            margin-bottom: 5px; /* Jarak antara teks dan link */
        }

        .pin-restricted-text a {
            color: #ffcc00; /* Warna kuning untuk link */
            text-decoration: underline;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="pinDetailOverlay">
        <div class="pin-detail-content">
            <div class="pin-detail-back-container">
                <button class="pin-detail-back-button" onclick="window.closePinDetail()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
            </div>

            <div class="pin-header-info">
                <h2 id="pinDetailTitle"></h2>
                <div class="uploaded-by-and-share">
                    <p class="uploaded-by-text">Dropped by <strong id="pinDetailUploadedBy"></strong></p>
                    <button id="pinDetailShareButton" class="secondary">
                        <i class="fas fa-share-alt"></i> Expose
                    </button>
                </div>
            </div>

            <div class="pin-detail-img-main-container">
                <button id="pinDetailImageSaveButton" class="pin-save-button image-overlay-button">Keep</button>
            </div>

            <p id="pinDetailDescription" class="pin-detail-description"></p>
            
            <!-- NEW: Like Section -->
            <div id="pinDetailLikeSection" class="pin-like-section" style="display: none;">
                <span id="likeStatusText" class="like-status-text"></span>
                <button id="likeButton" class="like-button">
                    <i class="fas fa-heart"></i> <span id="likeCount">0</span>
                </button>
            </div>

            <div id="pinDetailPersonTagsSection" class="pin-person-tags-section" style="display: none;">
                <h3 class="person-in-pin-title">Staring</h3>
                <div id="pinDetailPersonTagsList" class="person-tags-list"></div>
                <div id="pinDetailRelatedPins" class="pin-grid"></div>
            </div>

            <div class="dashed-line"></div>
            <div id="pinDetailCategories" class="pin-categories"></div>

            <div class="pin-detail-actions" style="display: none;">
            </div>
        </div>
    </div>

    <div id="fullImageOverlay" class="full-image-overlay">
        <button class="close-full-image-button" onclick="window.closeFullImageOverlay()">&times;</button>
        <img id="fullImageDisplay" src="" alt="Gambar Ukuran Penuh">
        <button id="fullImageDownloadButton" class="download-button-on-image">
            <i class="fas fa-download"></i> Take
        </button>
    </div>

    <div id="notificationOverlay">
        <div class="overlay-header">
            <h2>Notifikasi</h2>
            <button class="icon-button" aria-label="Tutup Notifikasi" id="closeNotificationButton">
                <i class="fas fa-times"></i> </button>
        </div>
        <div class="notification-page-container">
            <div class="notification-list" id="notificationListContainer">
                <p class="info-message">No touches yet. Still waiting.</p>
            </div>
        </div>
    </div>
    
    <div id="searchOverlay">
        <div class="overlay-header search-overlay-header">
            <div class="search-container">
                <div class="search-icon-wrapper">
                    <i class="fas fa-search"></i> <input type="search" placeholder="Cari ide" id="mobileSearchInputOverlay">
                </div>
            </div>
            <button id="closeSearchOverlay">Cancel</button>
        </div>
        <div class="overlay-content search-overlay-content">
            <div id="mobileSearchHistory"><h3>Previously turned you on…</h3><ul id="mobileSearchHistoryList" class="search-history-list"></ul></div>
            <ul id="searchSuggestions"></ul>
            <h3 id="categoryExploreTitle">Dive into your cravings</h3>
            <div class="category-grid" id="categoryGridMobile"></div>
        </div>
    </div>

    <!-- mobileProfileDropdown dihapus -->

    <header>
        <div class="logo" onclick="window.location.href='index.html'"></div>
        <div class="header-nav-links">
            <button class="nav-button active" data-nav="home">Playground</button>
            <button class="nav-button" data-nav="create" id="desktopCreateButton">Buat</button>
            <button class="nav-button saved" data-nav="saved">Obsession</button>
        </div>

        <div class="search-container">
            <div class="search-icon-wrapper">
                <i class="fas fa-search"></i> <input type="search" placeholder="Cari" id="desktopSearchInput">
            </div>
            <div id="desktopSearchHistory"><h3>Previously turned you on…</h3><ul id="desktopSearchHistoryList" class="search-history-list"></ul></div>
            <ul id="desktopSearchSuggestions"></ul>
        </div>
        <div class="header-icons">
            <button class="icon-button" aria-label="Notifikasi" id="notificationButton">
                <i class="fas fa-bell"></i> <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
            </button>
            <button class="icon-button" aria-label="Profil" id="profileButton"><div class="profile-icon" id="profileIconLetter">G</div></button>
            <button class="icon-button" aria-label="Akun Lainnya" id="moreAccountsButton">
                <i class="fas fa-caret-down"></i> </button>
            <ul class="dropdown-menu" id="moreAccountsDropdown">
                <li class="header-item" id="dropdownUsernameDisplay">Hey, Guest… come play with us.</li>
                <li id="dropdownMyProfile" style="display: none;">My Dirty Playground</li>
                <li id="dropdownAdminPanel" style="display: none;">Panel Admin</li>
                <li id="dropdownLogout" style="display: none;">Pull Out</li>
            </ul>
        </div>
        <button class="icon-button mobile-notification-icon" aria-label="Notifikasi" id="mobileNotificationButton">
               <i class="fas fa-bell"></i> <span class="notification-badge" id="mobileNotificationBadge" style="display: none;">0</span>
        </button>
    </header>
    
    <main>
        <section class="desktop-categories" id="desktopCategoriesSection">
            <h3>Dive into your cravings</h3>
            <div class="category-grid" id="categoryGridDesktop">
                </div>
        </section>
        <div class="pin-grid" id="pinGrid"></div>
        <!-- Skeleton Loader for initial pin loading -->
        <div id="skeletonLoader" class="pin-grid-skeleton">
            <div class="skeleton-pin"></div>
            <div class="skeleton-pin"></div>
            <div class="skeleton-pin"></div>
            <div class="skeleton-pin"></div>
            <div class="skeleton-pin"></div>
            <div class="skeleton-pin"></div>
        </div>
        <div id="loading-indicator">Fetching More Slutty Shots...</div>
    </main>

    <div class="mobile-bottom-nav-container">
        <nav class="mobile-bottom-nav">
            <div class="mobile-nav-item active" data-action="home">
                <i class="fas fa-home"></i> </div>
            <div class="mobile-nav-item" data-action="search">
                <i class="fas fa-search"></i> </div>
            <div class="mobile-nav-item" data-action="create-pin">
                   <i class="fas fa-plus"></i> </div>
            <div class="mobile-nav-item" data-action="profile">
                <div class="profile-icon" style="width:28px; height:28px;">G</div>
            </div>
        </nav>
    </div>

    <div id="customAlert" class="custom-alert"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let currentUser = null;
            let currentSearchQuery = ''; 
            let allPinsData = [];
            let savedPinsData = [];
            let currentView = 'home'; // 'home' or 'saved'

            const NOTIFICATION_LS_KEY_READ_STATUS = 'spicette_notifications_read';
            let searchSuggestionsData = [];
            let selectedSuggestionIndex = -1;

            const SEARCH_HISTORY_LS_KEY = 'spicette_search_history';
            const MAX_SEARCH_HISTORY = 5;
            let searchHistory = [];

            // Mengubah API_BASE_URL menjadi path absolut dari root domain
            const API_BASE_URL = '/Spicette/api/'; 

            async function makeApiRequest(endpoint, method = 'GET', data = null) {
                try {
                    const options = { method };
                    if (data !== null && typeof data !== 'undefined' && method !== 'GET') {
                        options.headers = { 'Content-Type': 'application/json' };
                        options.body = JSON.stringify(data);
                    }
                    
                    const response = await fetch(API_BASE_URL + endpoint, options);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Kesalahan HTTP! Status: ${response.status} - ${errorText}`);
                    }
                    
                    const textResponse = await response.text();
                    if (!textResponse) {
                        return { success: true, message: 'Tidak ada konten' };
                    }

                    try {
                        const jsonResponse = JSON.parse(textResponse);
                        return jsonResponse;
                    } catch (e) {
                        console.error('Gagal mengurai respons JSON:', textResponse);
                        throw new Error(`Respons JSON tidak valid: ${textResponse}`);
                    }

                } catch (error) {
                    console.error('Permintaan API Gagal:', error);
                    return { success: false, message: 'Kesalahan jaringan atau server.' };
                }
            }

            const customAlert = document.getElementById('customAlert');
            let alertTimeout;

            function showMessage(msg, type = 'info') {
                clearTimeout(alertTimeout);

                customAlert.textContent = msg;
                customAlert.className = 'custom-alert';
                if (type === 'error') {
                    customAlert.classList.add('error');
                } else if (type === 'success') {
                    customAlert.classList.add('success');
                }
                customAlert.classList.add('show');

                alertTimeout = setTimeout(() => {
                    customAlert.classList.remove('show');
                }, 3000);
            }
            
            const pinDetailOverlay = document.getElementById('pinDetailOverlay');
            const pinDetailImageMainContainer = document.querySelector('.pin-detail-img-main-container');
            const pinDetailTitle = document.getElementById('pinDetailTitle');
            const pinDetailUploadedBy = document.getElementById('pinDetailUploadedBy');
            const pinDetailDescription = document.getElementById('pinDetailDescription'); 
            const pinDetailCategories = document.getElementById('pinDetailCategories');
            const pinDetailImageSaveButton = document.getElementById('pinDetailImageSaveButton');
            const pinDetailShareButton = document.getElementById('pinDetailShareButton');
            const pinDetailPersonTagsSection = document.getElementById('pinDetailPersonTagsSection');
            const pinDetailPersonTagsList = document.getElementById('pinDetailPersonTagsList');
            const pinDetailRelatedPins = document.getElementById('pinDetailRelatedPins');

            // NEW: Elemen untuk fungsi like
            const pinDetailLikeSection = document.getElementById('pinDetailLikeSection');
            const likeStatusText = document.getElementById('likeStatusText');
            const likeButton = document.getElementById('likeButton');
            const likeCountSpan = document.getElementById('likeCount');


            // Fungsi helper untuk memperbaiki path gambar agar sesuai dengan struktur folder
            function getCorrectedImagePath(originalPath) {
                if (originalPath.startsWith('./uploads/pins/')) {
                    return originalPath.substring(2);
                }
                if (originalPath.startsWith('uploads/pins/')) {
                    return originalPath;
                }
                return originalPath; 
            }

            function updatePinDetailImageSaveButton(pinData) {
                if (currentUser && currentUser.savedPins && currentUser.savedPins.includes(pinData.id)) {
                    pinDetailImageSaveButton.textContent = 'Disimpan';
                    pinDetailImageSaveButton.style.backgroundColor = '#767676';
                    pinDetailImageSaveButton.onclick = async (e) => { 
                        e.stopPropagation(); 
                        const response = await makeApiRequest('pins.php?action=unsave', 'POST', { pinId: pinData.id });
                        if (response.success) {
                            showMessage('Pin berhasil dihapus dari daftar simpan!', 'success');
                            currentUser.savedPins = currentUser.savedPins.filter(id => id !== pinData.id);
                            updatePinDetailImageSaveButton(pinData);
                            const gridSaveButton = document.querySelector(`.pin[data-id="${pinData.id}"] .pin-save-button`);
                            if (gridSaveButton) {
                                gridSaveButton.textContent = 'Simpan';
                                gridSaveButton.style.backgroundColor = '#e60023';
                            }
                            if (currentView === 'saved') { // Perbaikan: Gunakan currentView
                                loadedPinsCount = 0;
                                await loadPins(pinsPerPage, false);
                            }
                        } else {
                            showMessage('Gagal menghapus pin dari daftar simpan: ' + response.message, 'error');
                        }
                    };
                } else {
                    pinDetailImageSaveButton.textContent = 'Simpan';
                    pinDetailImageSaveButton.style.backgroundColor = '#e60023';
                    pinDetailImageSaveButton.onclick = async (e) => { 
                        e.stopPropagation(); 
                        if (!currentUser) {
                            showMessage('Harap login untuk menyimpan pin.', 'info');
                            window.location.href = 'login.html';
                            return;
                        }
                        const response = await makeApiRequest('pins.php?action=save', 'POST', { pinId: pinData.id });
                        if (response.success) {
                            showMessage('Pin berhasil disimpan!', 'success');
                            if (currentUser.savedPins) {
                                currentUser.savedPins.push(pinData.id);
                            } else {
                                currentUser.savedPins = [pinData.id];
                            }
                            updatePinDetailImageSaveButton(pinData);
                            const gridSaveButton = document.querySelector(`.pin[data-id="${pinData.id}"] .pin-save-button`);
                            if (gridSaveButton) {
                                gridSaveButton.textContent = 'Disimpan';
                                gridSaveButton.style.backgroundColor = '#767676';
                            }
                            if (currentView === 'saved') { // Perbaikan: Gunakan currentView
                                loadedPinsCount = 0;
                                await loadPins(pinsPerPage, false);
                            }
                        } else {
                            showMessage('Gagal menyimpan pin: ' + response.message, 'error');
                        }
                    };
                }
            }

            window.closePinDetail = function() {
                pinDetailOverlay.style.display = 'none';
                document.body.classList.remove('no-scroll');

                const currentUrl = new URL(window.location.href);
                if (currentUrl.searchParams.has('pin')) {
                    currentUrl.searchParams.delete('pin');
                    history.pushState(null, '', currentUrl.toString());
                }
            };

            // NEW: Fungsi untuk memperbarui status dan jumlah like
            async function updateLikeStatus(pinId) {
                if (!currentUser) {
                    pinDetailLikeSection.style.display = 'none';
                    return;
                }
                pinDetailLikeSection.style.display = 'flex';

                // Perbarui status like pengguna
                const isLikedByUser = currentUser.liked_pins && currentUser.liked_pins.includes(pinId);
                if (isLikedByUser) {
                    likeStatusText.textContent = 'Kamu menyukai gambar ini!';
                    likeButton.classList.add('liked');
                } else {
                    likeStatusText.textContent = 'Sukai gambar ini?';
                    likeButton.classList.remove('liked');
                }

                // Perbarui jumlah like global
                const response = await makeApiRequest(`pins.php?action=get_pin_like_count&pinId=${pinId}`);
                if (response.success) {
                    likeCountSpan.textContent = response.count;
                } else {
                    likeCountSpan.textContent = '0'; // Default jika gagal
                    console.error('Gagal memuat jumlah like:', response.message);
                }

                // Atur event listener untuk tombol like
                likeButton.onclick = async (e) => {
                    e.stopPropagation();
                    const toggleResponse = await makeApiRequest('pins.php?action=toggle_like_pin', 'POST', { pinId: pinId });
                    if (toggleResponse.success) {
                        // Perbarui liked_pins di currentUser
                        if (toggleResponse.liked_status) {
                            if (!currentUser.liked_pins) currentUser.liked_pins = [];
                            currentUser.liked_pins.push(pinId);
                            showMessage('Pin berhasil disukai!', 'success');
                        } else {
                            currentUser.liked_pins = currentUser.liked_pins.filter(id => id !== pinId);
                            showMessage('Pin berhasil dibatalkan suka!', 'success');
                        }
                        // Muat ulang status like dan jumlah
                        updateLikeStatus(pinId);
                    } else {
                        showMessage('Gagal memperbarui status like: ' + toggleResponse.message, 'error');
                    }
                };
            }

            async function openPinDetail(pinData) {
                // Check if user has clear access to the pin
                if (!pinData.can_view_clearly) {
                    showMessage('Anda tidak memiliki izin untuk melihat pin ini.', 'error');
                    return; // Prevent opening the detail page
                }

                pinDetailTitle.textContent = pinData.title || 'Tanpa Judul';
                pinDetailUploadedBy.textContent = `${pinData.uploadedBy || 'Anonim'}`; 

                if (pinData.description) {
                    pinDetailDescription.textContent = pinData.description;
                    pinDetailDescription.style.display = 'block';
                } else {
                    pinDetailDescription.textContent = '';
                    pinDetailDescription.style.display = 'none';
                }
                
                pinDetailImageMainContainer.innerHTML = '';
                pinDetailImageMainContainer.appendChild(pinDetailImageSaveButton);

                if (pinData.images && pinData.images.length > 0) {
                    if (pinData.display_type === 'slider' && pinData.images.length > 1) {
                        const sliderWrapper = document.createElement('div');
                        sliderWrapper.className = 'slider-wrapper';
                        
                        const swipeInner = document.createElement('div');
                        swipeInner.className = 'swipe-inner';

                        pinData.images.forEach((image, index) => {
                            const slide = document.createElement('div');
                            slide.className = 'slider-slide';
                            const imgElement = document.createElement('img');
                            // Use url_original for detail view as we've already checked can_view_clearly
                            imgElement.src = getCorrectedImagePath(image.url_original || image.display_url); 
                            imgElement.alt = `${pinData.title} - ${index + 1}`;
                            imgElement.onerror = function() { 
                                this.onerror=null; 
                                this.src='https://placehold.co/500x700/cccccc/000000?text=Image+Load+Error';
                            };
                            imgElement.onclick = (e) => {
                                e.stopPropagation();
                                window.openFullImageOverlay(imgElement.src);
                            };
                            slide.appendChild(imgElement);
                            swipeInner.appendChild(slide);
                        });
                        sliderWrapper.appendChild(swipeInner);
                        pinDetailImageMainContainer.appendChild(sliderWrapper);

                    } else {
                        pinData.images.forEach(image => {
                            const imgDiv = document.createElement('div');
                            imgDiv.className = 'stacked-image-item';
                            const imgElement = document.createElement('img');
                            // Use url_original for detail view
                            imgElement.src = getCorrectedImagePath(image.url_original || image.display_url); 
                            imgElement.alt = pinData.title;
                            imgElement.onerror = function() { 
                                this.onerror=null; 
                                this.src='https://placehold.co/500x700/cccccc/000000?text=Image+Load+Error';
                            };
                            imgElement.onclick = (e) => {
                                e.stopPropagation();
                                window.openFullImageOverlay(imgElement.src);
                            };
                            imgDiv.appendChild(imgElement);

                            if (image.description) {
                                const descP = document.createElement('p');
                                descP.className = 'image-individual-description';
                                descP.textContent = image.description;
                                imgDiv.appendChild(descP);
                            }
                            pinDetailImageMainContainer.appendChild(imgDiv);
                        });
                    }
                } else {
                    const noImage = document.createElement('img');
                    noImage.src = 'https://placehold.co/500x700/cccccc/000000?text=Tidak+Ada+Gambar';
                    noImage.alt = 'Tidak Ada Gambar';
                    noImage.onclick = (e) => {
                        e.stopPropagation();
                        window.openFullImageOverlay(noImage.src);
                    };
                    pinDetailImageMainContainer.appendChild(noImage);
                }

                updatePinDetailImageSaveButton(pinData);
                await updateLikeStatus(pinData.id); // NEW: Panggil fungsi updateLikeStatus

                // Person Tags Section
                pinDetailPersonTagsList.innerHTML = '';
                pinDetailRelatedPins.innerHTML = '';
                if (pinData.personTags && pinData.personTags.length > 0) {
                    pinDetailPersonTagsSection.style.display = 'block';
                    const taggedPeople = pinData.personTags;
                    let allRelatedPins = [];
                    const maxPinsTotal = 15;
                    // Calculate max pins per person, ensuring at least 1 if there are people
                    const maxPinsPerPerson = taggedPeople.length > 0 ? Math.max(1, Math.floor(maxPinsTotal / taggedPeople.length)) : 0;

                    for (const person of taggedPeople) {
                        const personTagDiv = document.createElement('div');
                        personTagDiv.className = 'person-tag-item';

                        const personNameLink = document.createElement('a');
                        personNameLink.href = `${window.location.origin}/Spicette/who.php?name=${encodeURIComponent(person.trim())}`;
                        personNameLink.textContent = person.trim();
                        personNameLink.className = 'person-name-link';
                        personTagDiv.appendChild(personNameLink);

                        const viewAllButton = document.createElement('a');
                        viewAllButton.href = `${window.location.origin}/Spicette/who.php?name=${encodeURIComponent(person.trim())}`;
                        viewAllButton.className = 'view-all-button';
                        viewAllButton.innerHTML = `See Her All <i class="fas fa-arrow-right"></i>`;
                        personTagDiv.appendChild(viewAllButton);

                        pinDetailPersonTagsList.appendChild(personTagDiv);

                        const response = await makeApiRequest(`pins.php?action=getPinsByPersonTag&name=${encodeURIComponent(person.trim())}`);
                        if (response.success && response.pins) {
                            // Ambil sejumlah pin acak dari setiap orang
                            const shuffledPersonPins = response.pins.sort(() => 0.5 - Math.random());
                            const pinsForThisPerson = shuffledPersonPins.slice(0, maxPinsPerPerson);
                            allRelatedPins.push(...pinsForThisPerson);
                        }
                    }

                    // Pastikan keunikan dan batasi total pin
                    const uniqueRelatedPins = Array.from(new Set(allRelatedPins.filter(p => p.id !== pinData.id).map(p => JSON.stringify(p))))
                                                .map(s => JSON.parse(s));

                    // Acak lagi dan batasi hingga maksimal 15 pin
                    const finalShuffledRelatedPins = uniqueRelatedPins.sort(() => 0.5 - Math.random()).slice(0, maxPinsTotal);


                    if (finalShuffledRelatedPins.length > 0) {
                        finalShuffledRelatedPins.forEach(relatedPin => {
                            // Only display related pins if the user can view them clearly
                            if (relatedPin.can_view_clearly) {
                                const pinElement = createPinElement(relatedPin);
                                pinDetailRelatedPins.appendChild(pinElement);
                            }
                        });
                    } else {
                        // Menggunakan kelas CSS baru
                        pinDetailRelatedPins.innerHTML = '<p class="no-related-pins-message">Tidak ada pin terkait lainnya.</p>';
                        pinDetailRelatedPins.style.display = 'block';
                    }

                } else {
                    pinDetailPersonTagsSection.style.display = 'none';
                }

                // Mengelola kategori
                pinDetailCategories.innerHTML = '';
                if (pinData.categories && Array.isArray(pinData.categories) && pinData.categories.length > 0) { 
                    pinData.categories.forEach(categoryName => {
                        const span = document.createElement('span');
                        span.classList.add('pin-category-tag');
                        const categoryPermalink = categoryName.trim().toLowerCase().replace(/ /g, '-');
                        span.innerHTML = `<a href="${window.location.origin}/Spicette/tag/${encodeURIComponent(categoryPermalink)}" style="color: inherit; text-decoration: none;">#${categoryName.trim()}</a>`;
                        pinDetailCategories.appendChild(span);
                    });
                    pinDetailCategories.style.display = 'flex';
                } else {
                    pinDetailCategories.style.display = 'none';
                }


                if (navigator.share) {
                    pinDetailShareButton.style.display = 'flex';
                    pinDetailShareButton.onclick = async (e) => {
                        e.stopPropagation();
                        try {
                            await navigator.share({
                                title: pinData.title || 'Pin Spicette',
                                text: pinData.description || pinData.title || 'Lihat pin ini!',
                                url: window.location.href
                            });
                            showMessage('Pin berhasil dibagikan!', 'success');
                        } catch (error) {
                            console.error('Kesalahan berbagi:', error);
                            showMessage('Gagal membagikan pin.', 'error');
                        }
                    };
                } else {
                    pinDetailShareButton.style.display = 'none';
                }

                pinDetailOverlay.style.display = 'flex';
                document.body.classList.add('no-scroll');

                const newUrl = new URL(window.location.href);
                newUrl.searchParams.set('pin', pinData.id);
                history.pushState({ pinId: pinData.id }, '', newUrl.toString());
            }

            window.onpopstate = (event) => {
                const urlParams = new URLSearchParams(window.location.search);
                const pinIdFromUrl = urlParams.get('pin');
                if (pinIdFromUrl) {
                    const pinToOpen = (allPinsData || []).find(pin => pin.id === pinIdFromUrl) || (savedPinsData || []).find(pin => pin.id === pinIdFromUrl);
                    if (pinToOpen) {
                        // Re-check permission before opening from URL history
                        if (pinToOpen.can_view_clearly) {
                            openPinDetail(pinToOpen);
                        } else {
                            // If not allowed to view clearly, close detail and remove pin param from URL
                            window.closePinDetail();
                            const currentUrl = new URL(window.location.href);
                            currentUrl.searchParams.delete('pin');
                            history.replaceState(null, '', currentUrl.toString());
                            window.location.href = '/Spicette/chat'; // Redirect to chat
                        }
                    } else {
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.delete('pin');
                        history.replaceState(null, '', currentUrl.toString());
                    }
                } else {
                    window.closePinDetail();
                }
            };

            const fullImageOverlay = document.getElementById('fullImageOverlay');
            const fullImageDisplay = document.getElementById('fullImageDisplay');
            const fullImageDownloadButton = document.getElementById('fullImageDownloadButton');

            window.openFullImageOverlay = function(imageUrl) { 
                if (fullImageDisplay) { 
                    fullImageDisplay.src = imageUrl;
                    fullImageDisplay.onerror = function() { 
                        this.onerror=null; 
                        this.src='https://placehold.co/1000x1200/cccccc/000000?text=Image+Load+Error';
                    };
                }
                if (fullImageOverlay) { 
                    fullImageOverlay.style.display = 'flex';
                }
                document.body.style.overflow = 'hidden';

                if (fullImageDownloadButton) { 
                    fullImageDownloadButton.onclick = (e) => {
                        e.stopPropagation();
                        downloadPin(imageUrl);
                    };
                }
            };

            window.closeFullImageOverlay = function() { 
                if (fullImageOverlay) { 
                    fullImageOverlay.style.display = 'none';
                }
                document.body.style.overflow = '';
            };

            const notificationOverlay = document.getElementById('notificationOverlay');
            const closeNotificationButton = document.getElementById('closeNotificationButton');
            const notificationListContainer = document.getElementById('notificationListContainer');

            async function openNotificationPage() {
                notificationListContainer.innerHTML = '<p class="info-message">Memuat notifikasi...</p>';
                const response = await makeApiRequest('notifications.php?action=fetch_all');
                
                if (response.success && response.notifications.length > 0) {
                    notificationListContainer.innerHTML = '';
                    response.notifications.forEach(notif => {
                        const notifItem = document.createElement('div');
                        notifItem.classList.add('notification-item');
                        if (notif.read) {
                            notifItem.classList.add('read');
                        }
                        
                        let linkButtonHtml = '';
                        if (notif.link && (notif.link.startsWith('http://') || notif.link.startsWith('https://'))) {
                            linkButtonHtml = `<a href="${notif.link}" target="_blank" class="notification-link-button"><i class="fas fa-external-link-alt"></i> Lihat</a>`;
                        }

                        notifItem.innerHTML = `
                            ${notif.text} 
                            <span style="font-size:0.8em; color:#999; display:block; margin-top:5px;">(${notif.timestamp || 'Tanggal tidak diketahui'})</span>
                            ${linkButtonHtml}
                        `;
                        notificationListContainer.appendChild(notifItem);
                    });
                    markAllNotificationsAsRead();
                } else {
                    notificationListContainer.innerHTML = '<p class="info-message">Tidak ada notifikasi baru.</p>';
                }

                notificationOverlay.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            function closeNotificationPage() {
                notificationOverlay.style.display = 'none';
                document.body.style.overflow = '';
            }

            closeNotificationButton.addEventListener('click', closeNotificationPage);

            const mainElement = document.querySelector('main');
            const pinGrid = document.getElementById('pinGrid');
            const loadingIndicator = document.getElementById('loading-indicator');
            const desktopCategoriesSection = document.getElementById('desktopCategoriesSection');
            const skeletonLoader = document.getElementById('skeletonLoader'); // Get skeleton loader element

            let pinsPerPage = 20; 
            let loadedPinsCount = 0; 

            function createPinElement(pinData) {
                const pinDiv = document.createElement('div');
                pinDiv.classList.add('pin');
                pinDiv.dataset.id = pinData.id;

                // Use display_url provided by backend, which is already determined based on user access
                const firstImage = pinData.images && pinData.images.length > 0 ? pinData.images[0] : null;
                const imageUrlToDisplay = firstImage ? getCorrectedImagePath(firstImage.display_url) : 'https://placehold.co/250x350/cccccc/000000?text=No+Image';

                const img = document.createElement('img');
                img.src = imageUrlToDisplay;
                img.alt = 'Gambar Pin';
                img.onerror = function() { 
                    this.onerror=null; 
                    this.src='https://placehold.co/250x350/cccccc/000000?text=Image+Error';
                };

                const overlayDiv = document.createElement('div');
                overlayDiv.classList.add('pin-overlay');
                
                const overlayTop = document.createElement('div');
                overlayTop.classList.add('pin-overlay-top');
                
                const saveButton = document.createElement('button');
                saveButton.classList.add('pin-save-button');
                
                if (currentUser && currentUser.savedPins && currentUser.savedPins.includes(pinData.id)) {
                    saveButton.textContent = 'Disimpan';
                    saveButton.style.backgroundColor = '#767676';
                } else {
                    saveButton.textContent = 'Simpan';
                    saveButton.style.backgroundColor = '#e60023';
                }
                
                saveButton.onclick = async (e) => { 
                    e.stopPropagation(); 
                    if (!currentUser) {
                        showMessage('Harap login untuk menyimpan pin.', 'info');
                        window.location.href = '/Spicette/login.html';
                        return;
                    }

                    if (currentUser.savedPins && currentUser.savedPins.includes(pinData.id)) {
                        const response = await makeApiRequest('pins.php?action=unsave', 'POST', { pinId: pinData.id });
                        if (response.success) {
                            showMessage('Pin berhasil dihapus dari daftar simpan!', 'success');
                            saveButton.textContent = 'Simpan';
                            saveButton.style.backgroundColor = '#e60023';
                            currentUser.savedPins = currentUser.savedPins.filter(id => id !== pinData.id);
                            if (pinDetailOverlay.style.display === 'flex' && pinDetailImageSaveButton && pinDetailImageSaveButton.textContent === 'Disimpan') {
                                updatePinDetailImageSaveButton(pinData);
                            }
                            if (currentView === 'saved') {
                                loadedPinsCount = 0;
                                await loadPins(pinsPerPage, false);
                            }
                        } else {
                            showMessage('Gagal menghapus pin dari daftar simpan: ' + response.message, 'error');
                        }
                    } else {
                        const response = await makeApiRequest('pins.php?action=save', 'POST', { pinId: pinData.id });
                        if (response.success) {
                            showMessage('Pin berhasil disimpan!', 'success');
                            saveButton.textContent = 'Disimpan';
                            saveButton.style.backgroundColor = '#767676';
                            if (currentUser.savedPins) {
                                currentUser.savedPins.push(pinData.id);
                            } else {
                                currentUser.savedPins = [pinData.id];
                            }
                            if (pinDetailOverlay.style.display === 'flex' && pinDetailImageSaveButton && pinDetailImageSaveButton.textContent === 'Simpan') {
                                updatePinDetailImageSaveButton(pinData);
                            }
                            if (currentView === 'saved') {
                                loadedPinsCount = 0;
                                await loadPins(pinsPerPage, false);
                            }
                        } else {
                            showMessage('Gagal menyimpan pin: ' + response.message, 'error');
                        }
                    }
                };
                overlayTop.appendChild(saveButton);

                if (pinData.images && pinData.images.length > 1) {
                    const imageCountOverlay = document.createElement('div');
                    imageCountOverlay.className = 'pin-image-count-overlay';
                    imageCountOverlay.innerHTML = `
                        <i class="fas fa-camera"></i>
                        <span>${pinData.images.length}</span>
                    `;
                    overlayTop.appendChild(imageCountOverlay);
                }


                const overlayBottom = document.createElement('div');
                overlayBottom.classList.add('pin-overlay-bottom');

                const pinTitle = document.createElement('div'); 
                pinTitle.classList.add('pin-title');
                pinTitle.textContent = pinData.title || 'Tanpa Judul'; 
                overlayBottom.appendChild(pinTitle);

                const bottomActions = document.createElement('div'); 
                bottomActions.classList.add('pin-bottom-actions');

                const infoDiv = document.createElement('div'); 
                infoDiv.classList.add('pin-info');
                if (pinData.categories && Array.isArray(pinData.categories) && pinData.categories.length > 0) { 
                     const link = document.createElement('a');
                     link.href = `${window.location.origin}/Spicette/tag/${encodeURIComponent(pinData.categories[0].trim().toLowerCase().replace(/ /g, '-'))}`;
                     link.target = '_blank';
                     link.textContent = pinData.categories[0];
                     link.onclick = (e) => e.stopPropagation(); 
                     infoDiv.appendChild(link);
                } else {
                    infoDiv.textContent = 'Tanpa Kategori';
                    infoDiv.style.opacity = '0.7'; 
                }
                bottomActions.appendChild(infoDiv);

                overlayBottom.appendChild(bottomActions); 
                
                overlayDiv.appendChild(overlayTop);
                overlayDiv.appendChild(overlayBottom);

                pinDiv.appendChild(img);
                pinDiv.appendChild(overlayDiv);
                
                // NEW: Logic for blurring and restricted access overlay
                if (!pinData.can_view_clearly) {
                    pinDiv.classList.add('pin-blurred');
                    const restrictedOverlay = document.createElement('div');
                    restrictedOverlay.classList.add('pin-overlay-restricted');
                    const restrictedText = document.createElement('span');
                    restrictedText.classList.add('pin-restricted-text');
                    restrictedText.innerHTML = 'Level anda tidak dijinkan, silakan <a href="/Spicette/chat">hubungi admin</a>'; // Link ke chat
                    restrictedOverlay.appendChild(restrictedText);
                    pinDiv.appendChild(restrictedOverlay);

                    // Override click behavior for blurred pins to redirect to chat
                    pinDiv.onclick = (e) => {
                        e.stopPropagation(); // Prevent opening pin detail
                        window.location.href = '/Spicette/chat'; // Redirect to chat page
                    };
                } else {
                    pinDiv.onclick = () => openPinDetail(pinData);
                }
                
                return pinDiv;
            }

            async function loadPersonalizedHomeFeed(count, append = true) {
                // Show skeleton loader only for initial load
                if (!append) {
                    pinGrid.style.display = 'none';
                    skeletonLoader.style.display = 'column';
                    loadingIndicator.style.display = 'none';
                } else {
                    loadingIndicator.style.display = 'block';
                }

                // If no user is logged in, load all pins unpersonalized
                if (!currentUser) {
                    await loadPinsUnpersonalized(count, append);
                    return;
                }

                // Fetch all pins if not already available or if a fresh load is requested
                if (allPinsData.length === 0 || !append) {
                    const response = await makeApiRequest('pins.php?action=fetch_all');
                    if (response.success) {
                        allPinsData = response.pins || [];
                        // Sort all pins by creation date, newest first
                        allPinsData.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    } else {
                        showMessage('Gagal memuat pin: ' + response.message, 'error');
                        pinGrid.innerHTML = '<p class="info-message error-message">Error memuat pin. Silakan coba lagi nanti.</p>';
                        skeletonLoader.style.display = 'none';
                        loadingIndicator.style.display = 'none';
                        return;
                    }
                }
                
                const userPreferredCategories = currentUser.preferred_categories || [];
                const userPreferredPersons = currentUser.preferred_persons || [];
                const userSavedPins = currentUser.savedPins || [];
                const userLikedPins = currentUser.liked_pins || []; // NEW: Ambil pin yang disukai pengguna

                const relevantPins = new Set();
                const allRecentPins = [];

                // Filter and categorize pins
                allPinsData.forEach(pin => {
                    // Add to allRecentPins (already sorted by creation date)
                    allRecentPins.push(pin);

                    // Check for relevance
                    const isCategoryMatch = pin.categories && pin.categories.some(cat => userPreferredCategories.includes(cat));
                    const isPersonMatch = pin.personTags && pin.personTags.some(person => userPreferredPersons.includes(person));
                    const isSaved = userSavedPins.includes(pin.id);
                    const isLiked = userLikedPins.includes(pin.id); // NEW: Cek apakah pin disukai

                    if (isCategoryMatch || isPersonMatch || isSaved || isLiked) { // NEW: Sertakan pin yang disukai
                        relevantPins.add(pin);
                    }
                });

                // Convert sets to arrays and remove duplicates by ID
                const uniqueRelevantPins = Array.from(relevantPins);
                // Sort relevant pins by how many criteria they match (simple scoring) or just creation date
                // For simplicity, let's keep them somewhat ordered, or randomize if needed.
                // For now, no specific sorting for relevant pins, just their existence.

                // Combine logic: 70% relevant, 30% recent
                const totalPinsToLoad = count;
                const numRelevant = Math.ceil(totalPinsToLoad * 0.7);
                const numRecent = totalPinsToLoad - numRelevant;

                let finalPins = [];
                let relevantCount = 0;
                let recentCount = 0;
                let usedPinIds = new Set();

                // Add relevant pins first, avoiding duplicates
                for (const pin of uniqueRelevantPins) {
                    if (relevantCount < numRelevant && !usedPinIds.has(pin.id)) {
                        finalPins.push(pin);
                        usedPinIds.add(pin.id);
                        relevantCount++;
                    }
                }

                // Fill remaining spots with recent pins, avoiding duplicates and pins already added
                for (const pin of allRecentPins) {
                    if (finalPins.length < totalPinsToLoad && !usedPinIds.has(pin.id)) {
                        finalPins.push(pin);
                        usedPinIds.add(pin.id);
                        recentCount++;
                    }
                    if (finalPins.length >= totalPinsToLoad) break;
                }
                
                // If not enough pins, just take what's available (already sorted by creation date, implicitly)
                // If still not enough, fill with any remaining pins (already in allPinsData)
                let remainingPinsFromAll = allPinsData.filter(pin => !usedPinIds.has(pin.id));
                finalPins.push(...remainingPinsFromAll.slice(0, totalPinsToLoad - finalPins.length));


                const startIndex = append ? loadedPinsCount : 0;
                const slicedPinsToDisplay = finalPins.slice(startIndex, startIndex + count);

                if (!append) {
                    pinGrid.innerHTML = '';
                    loadedPinsCount = 0;
                }

                const fragment = document.createDocumentFragment();
                slicedPinsToDisplay.forEach(pinData => {
                    const pinElement = createPinElement(pinData);
                    fragment.appendChild(pinElement);
                    loadedPinsCount++;
                });
                pinGrid.appendChild(fragment);

                // Show grid and hide loaders
                skeletonLoader.style.display = 'none';
                loadingIndicator.style.display = 'none';
                if (pinGrid) { 
                    pinGrid.style.removeProperty('display');
                    pinGrid.style.display = 'column';
                }

                if (finalPins.length === 0) {
                    pinGrid.innerHTML = '<p class="info-message">Tidak ada pin untuk ditampilkan.</p>';
                } else if (slicedPinsToDisplay.length === 0 && loadedPinsCount > 0) {
                    // All pins loaded
                }
            }


            async function loadPinsUnpersonalized(count, append = true) {
                // This function is for guest users or when no personalization applies
                // Show skeleton loader only for initial load or tab switch
                if (!append) {
                    pinGrid.style.display = 'none';
                    skeletonLoader.style.display = 'column'; // Show skeleton
                    loadingIndicator.style.display = 'none'; // Hide loading indicator during skeleton display
                } else {
                    loadingIndicator.style.display = 'block'; // Show loading indicator for appending
                }

                let endpoint = '';
                let params = '';
                let pinsToProcess = [];

                if (currentSearchQuery) { 
                    endpoint = 'pins.php?action=search'; // Changed to general search action
                    params = `&query=${encodeURIComponent(currentSearchQuery)}`;
                } else if (currentView === 'home') {
                    endpoint = 'pins.php?action=fetch_all';
                } else if (currentView === 'saved') {
                    if (!currentUser) {
                        // Langsung alihkan ke login.html jika belum login
                        window.location.href = 'login.html';
                        return;
                    }
                    endpoint = `pins.php?action=fetch_saved&username=${currentUser.username}`;
                }

                const response = await makeApiRequest(`${endpoint}${params}`);
                
                // Hide skeleton and loading indicator after data is fetched
                skeletonLoader.style.display = 'none';
                loadingIndicator.style.display = 'none';

                if (response.success) {
                    pinsToProcess = response.pins || []; 
                    
                    if (currentView === 'home') {
                        allPinsData = pinsToProcess;
                    } else if (currentView === 'saved') {
                        savedPinsData = pinsToProcess;
                    }

                    const startIndex = append ? loadedPinsCount : 0;
                    const slicedPinsToDisplay = pinsToProcess.slice(startIndex, startIndex + count);

                    if (!append) {
                        pinGrid.innerHTML = '';
                        loadedPinsCount = 0;
                    }

                    const fragment = document.createDocumentFragment();
                    slicedPinsToDisplay.forEach(pinData => {
                        const pinElement = createPinElement(pinData);
                        fragment.appendChild(pinElement);
                        loadedPinsCount++;
                    });
                    pinGrid.appendChild(fragment);

                    if (slicedPinsToDisplay.length > 0 || currentSearchQuery === '') {
                        if (pinGrid) { // Null check for pinGrid
                            pinGrid.style.removeProperty('display');
                            pinGrid.style.display = 'column';
                        }
                    }

                    if (pinsToProcess.length === 0) {
                        if (currentSearchQuery) {
                            pinGrid.innerHTML = `<p class="info-message">Tidak ada pin ditemukan untuk "${currentSearchQuery}".</p>`;
                        } else if (currentView === 'home') {
                            pinGrid.innerHTML = '<p class="info-message">Tidak ada pin untuk ditampilkan.</p>';
                        } else if (currentView === 'saved') {
                            pinGrid.innerHTML = '<p class="info-message">Anda belum menyimpan pin apa pun.</p>';
                        }
                    }
                } else {
                    showMessage('Gagal memuat pin: ' + response.message, 'error');
                    pinGrid.innerHTML = '<p class="info-message error-message">Error memuat pin. Silakan coba lagi nanti.</p>';
                }
            }


            // Renaming the old `loadPins` to `_loadPins` for internal use or removing it
            // The `loadPins` function now becomes the main orchestrator based on `currentView`
            async function loadPins(count, append = true) {
                if (currentView === 'home' && !currentSearchQuery) {
                    await loadPersonalizedHomeFeed(count, append);
                } else if (currentView === 'saved' || currentSearchQuery) {
                    // For 'saved' view or search results, use the unpersonalized loader
                    await loadPinsUnpersonalized(count, append);
                }
            }


            function loadSearchHistory() {
                const historyJson = localStorage.getItem(SEARCH_HISTORY_LS_KEY);
                if (historyJson) {
                    searchHistory = JSON.parse(historyJson);
                } else {
                    searchHistory = [];
                }
            }

            function saveSearchHistory() {
                localStorage.setItem(SEARCH_HISTORY_LS_KEY, JSON.stringify(searchHistory));
            }

            function addSearchToHistory(query) {
                query = query.toLowerCase().trim();
                if (!query) return;

                searchHistory = searchHistory.filter(item => item !== query);
                searchHistory.unshift(query);
                if (searchHistory.length > MAX_SEARCH_HISTORY) {
                    searchHistory = searchHistory.slice(0, MAX_SEARCH_HISTORY);
                }
                saveSearchHistory();
                renderSearchHistory();
            }

            const desktopSearchHistoryContainer = document.getElementById('desktopSearchHistory');
            const desktopSearchHistoryList = document.getElementById('desktopSearchHistoryList');
            const mobileSearchHistoryContainer = document.getElementById('mobileSearchHistory');
            const mobileSearchHistoryList = document.getElementById('mobileSearchHistoryList');

            function renderSearchHistory() {
                if (desktopSearchHistoryList) { 
                    desktopSearchHistoryList.innerHTML = '';
                }
                if (mobileSearchHistoryList) { 
                    mobileSearchHistoryList.innerHTML = '';
                }

                if (searchHistory.length === 0) {
                    if (desktopSearchHistoryContainer) desktopSearchHistoryContainer.style.display = 'none';
                    if (mobileSearchHistoryContainer) mobileSearchHistoryContainer.style.display = 'none';
                    return;
                }

                if (desktopSearchHistoryContainer) desktopSearchHistoryContainer.style.display = 'block';
                if (mobileSearchHistoryContainer) mobileSearchHistoryContainer.style.display = 'block';

                searchHistory.forEach(historyItem => {
                    if (desktopSearchHistoryList) {
                        const desktopLi = document.createElement('li');
                        desktopLi.textContent = historyItem;
                        desktopLi.addEventListener('click', () => {
                            window.location.href = `/Spicette/search.php?query=${encodeURIComponent(historyItem)}`;
                        });
                        desktopSearchHistoryList.appendChild(desktopLi);
                    }

                    if (mobileSearchHistoryList) {
                        const mobileLi = document.createElement('li');
                        mobileLi.textContent = historyItem;
                        mobileLi.addEventListener('click', () => {
                            window.location.href = `/Spicette/search.php?query=${encodeURIComponent(historyItem)}`;
                        });
                        mobileSearchHistoryList.appendChild(mobileLi);
                    }
                });
            }

            const mobileSearchInputOverlay = document.getElementById('mobileSearchInputOverlay'); 
            const desktopSearchInput = document.getElementById('desktopSearchInput'); 
            const searchSuggestionsListMobile = document.getElementById('searchSuggestions');
            const searchSuggestionsListDesktop = document.getElementById('desktopSearchSuggestions'); 
            const categoryExploreTitle = document.getElementById('categoryExploreTitle');
            const categoryGridMobile = document.getElementById('categoryGridMobile');

            let searchTimeout;

            function showSuggestions(inputElement, suggestionsList, query) {
                suggestionsList.innerHTML = '';
                suggestionsList.style.display = 'none'; 

                if (query.length < 2) { 
                    if (categoryExploreTitle) categoryExploreTitle.style.display = 'block'; // Null check
                    if (categoryGridMobile) categoryGridMobile.style.display = 'grid'; // Null check
                    renderSearchHistory(); 
                    return;
                }
                
                if (inputElement && inputElement.id === 'desktopSearchInput' && desktopSearchHistoryContainer) { 
                    desktopSearchHistoryContainer.style.display = 'none';
                } else if (mobileSearchHistoryContainer) { 
                    mobileSearchHistoryContainer.style.display = 'none';
                }

                // Combine allPinsData and savedPinsData for search suggestions
                const combinedPinsData = [...allPinsData, ...savedPinsData];
                const filteredSuggestions = combinedPinsData.filter(pin => 
                    (pin.title && pin.title.toLowerCase().includes(query.toLowerCase())) ||
                    (pin.description && pin.description.toLowerCase().includes(query.toLowerCase())) || 
                    (pin.category && pin.category.toLowerCase().includes(query.toLowerCase())) || 
                    (pin.images && pin.images.some(img => img.description && img.description.toLowerCase().includes(query.toLowerCase()))) 
                ).map(pin => pin.title || pin.category).filter(Boolean).slice(0, 5); 

                const uniqueSuggestions = [...new Set(filteredSuggestions)];

                if (uniqueSuggestions.length > 0) {
                    uniqueSuggestions.forEach(suggestion => {
                        const listItem = document.createElement('li');
                        listItem.textContent = suggestion;
                        listItem.addEventListener('click', () => {
                            window.location.href = `/Spicette/search.php?query=${encodeURIComponent(suggestion)}`;
                        });
                        suggestionsList.appendChild(listItem);
                    });
                    suggestionsList.style.display = 'block';
                    if (categoryExploreTitle) categoryExploreTitle.style.display = 'none'; // Null check
                    if (categoryGridMobile) categoryGridMobile.style.display = 'none'; // Null check
                } else {
                    suggestionsList.style.display = 'none';
                    if (categoryExploreTitle) categoryExploreTitle.style.display = 'block'; // Null check
                    if (categoryGridMobile) categoryGridMobile.style.display = 'grid'; // Null check
                }
            }

            async function performSearch(query) {
                window.location.href = `/Spicette/search.php?query=${encodeURIComponent(query)}`;
            }

            mobileSearchInputOverlay.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                searchTimeout = setTimeout(() => {
                    showSuggestions(mobileSearchInputOverlay, searchSuggestionsListMobile, query);
                }, 300);
            });

            mobileSearchInputOverlay.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault(); 
                    const query = mobileSearchInputOverlay.value.trim();
                    if (query) {
                        performSearch(query); 
                        closeSearch(); 
                    }
                }
            });

            if (desktopSearchInput) { 
                desktopSearchInput.addEventListener('focus', () => {
                    if (mainElement) mainElement.classList.add('desktop-search-active'); // Null check
                    if (pinGrid) pinGrid.style.display = 'none'; // Null check
                    if (loadingIndicator) loadingIndicator.style.display = 'none'; // Null check
                    if (desktopCategoriesSection) desktopCategoriesSection.style.display = 'none'; // Null check
                    desktopSearchInput.value = currentSearchQuery; 
                    renderSearchHistory(); 
                    if (searchSuggestionsListDesktop) searchSuggestionsListDesktop.style.display = 'none';
                });

                desktopSearchInput.addEventListener('blur', (event) => {
                    setTimeout(() => {
                        const searchArea = document.querySelector('header .search-container');
                        const isClickInsideDesktopSearchUI = searchArea && (searchArea.contains(event.relatedTarget) ||
                                                     (searchSuggestionsListDesktop && searchSuggestionsListDesktop.contains(event.relatedTarget)) ||
                                                     (desktopSearchHistoryContainer && desktopSearchHistoryContainer.contains(event.relatedTarget)));
                        
                        if (!isClickInsideDesktopSearchUI) {
                            resetMainContent();
                        }
                    }, 100); 
                });

                desktopSearchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    const query = e.target.value.trim();
                    currentSearchQuery = query; 
                    searchTimeout = setTimeout(() => {
                        showSuggestions(desktopSearchInput, searchSuggestionsListDesktop, query);
                    }, 300);
                });

                desktopSearchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); 
                        const query = desktopSearchInput.value.trim();
                        if (query) {
                            addSearchToHistory(query);
                            window.location.href = `/Spicette/search.php?query=${encodeURIComponent(query)}`; 
                        }
                    }
                });
            }
            
            async function resetMainContent() {
                if (desktopSearchInput) desktopSearchInput.value = ''; 
                currentSearchQuery = ''; 
                if (searchSuggestionsListDesktop) searchSuggestionsListDesktop.style.display = 'none';
                if (desktopSearchHistoryContainer) desktopSearchHistoryContainer.style.display = 'none';
                
                if (mainElement) mainElement.classList.remove('desktop-search-active'); // Null check
                
                // Restore categories section visibility based on currentView
                if (currentView === 'home') {
                    if (desktopCategoriesSection) desktopCategoriesSection.style.display = 'block'; // Null check
                } else {
                    if (desktopCategoriesSection) desktopCategoriesSection.style.display = 'none'; // Null check
                }

                if (pinGrid) { // Null check
                    pinGrid.style.removeProperty('display'); 
                    pinGrid.style.display = 'column'; 
                }
                
                loadedPinsCount = 0; 
                await loadPins(pinsPerPage, false); 
            }

            document.addEventListener('click', (event) => {
                const headerSearchContainer = document.querySelector('header .search-container');
                const isClickInsideDesktopSearchUI = headerSearchContainer && (headerSearchContainer.contains(event.target) ||
                                                 (searchSuggestionsListDesktop && searchSuggestionsListDesktop.contains(event.target)) || // Null check
                                                 (desktopSearchHistoryContainer && desktopSearchHistoryContainer.contains(event.target))); // Null check
            
                if (desktopSearchInput && !desktopSearchInput.matches(':focus') && !isClickInsideDesktopSearchUI) {
                    resetMainContent();
                }

                const isClickInsideMobileSearchOverlay = searchOverlay.contains(event.target);
                const mobileSearchTriggerButton = document.querySelector('.mobile-nav-item[data-action="search"]'); 
                const isMobileSearchTriggerButtonClick = mobileSearchTriggerButton && mobileSearchTriggerButton.contains(event.target);
                
                if (searchOverlay.style.display === 'flex' && !isClickInsideMobileSearchOverlay && !isMobileSearchTriggerButtonClick) {
                    closeSearch();
                }
            });

            async function loadCategories() {
                const categoryContainers = [
                    document.getElementById('categoryGridMobile'),
                    document.getElementById('categoryGridDesktop') 
                ];

                try {
                    const response = await makeApiRequest('categories.php?action=fetch_all');
                    if (response.success && response.categories) {
                        const categories = response.categories; 
                        const filteredCategories = categories.filter(cat => cat.name && cat.name.trim() !== '');

                        categoryContainers.forEach(container => {
                            if (!container) return; 
                            container.innerHTML = ''; 
                            const fragment = document.createDocumentFragment();

                            filteredCategories.forEach((cat) => {
                                const catItem = document.createElement('div');
                                catItem.className = 'category-item';
                                
                                const imageUrl = cat.imageUrl || `https://picsum.photos/200/200?random=${Math.random()}`; 
                                catItem.style.backgroundImage = `url('${imageUrl}')`;

                                const catTitle = document.createElement('span');
                                catTitle.textContent = cat.name; 
                                
                                catItem.appendChild(catTitle);
                                
                                catItem.onclick = function() {
                                    const categoryPermalink = cat.name.trim().toLowerCase().replace(/ /g, '-');
                                    window.location.href = `/Spicette/tag/${encodeURIComponent(categoryPermalink)}`;
                                };
                                fragment.appendChild(catItem);
                            });
                            container.appendChild(fragment);
                        });
                    } else {
                        console.error('Gagal memuat kategori:', response.message);
                        categoryContainers.forEach(container => {
                            if (container) container.innerHTML = '<p class="info-message">Gagal memuat kategori.</p>';
                        });
                    }
                } catch (error) {
                    console.error('Error mengambil kategori:', error);
                    categoryContainers.forEach(container => {
                        if (container) container.innerHTML = '<p class="info-message">Kesalahan jaringan saat memuat kategori.</p>';
                    });
                }
            }
            
            loadCategories();

            window.addEventListener('scroll', () => {
                // Null check for loadingIndicator as it might be null if search is active
                const currentLoadingIndicator = loadingIndicator; 

                if (currentLoadingIndicator && currentLoadingIndicator.style.display === 'none' && 
                    searchOverlay.style.display === 'none' && 
                    // mobileProfileDropdown.style.display === 'none' && // mobileProfileDropdown dihapus
                    pinDetailOverlay.style.display === 'none' && 
                    fullImageOverlay.style.display === 'none' &&
                    notificationOverlay.style.display === 'none' 
                ) {
                    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 400) {
                        if (!currentSearchQuery) { 
                            loadPins(pinsPerPage, true);
                        }
                    }
                }
            });
            
            const headerNavButtons = document.querySelectorAll('.header-nav-links .nav-button');
            const desktopCreateButton = document.getElementById('desktopCreateButton');

            desktopCreateButton.addEventListener('click', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    window.location.href = 'login.html'; 
                } else if (!['Naughty', 'Sinful'].includes(currentUser.level)) { // NEW: Check user level for upload permission
                    showMessage('Anda tidak memiliki izin untuk membuat pin. Hanya pengguna Naughty dan Sinful yang diizinkan.', 'error');
                } else {
                    window.location.href = 'create.html';
                }
            });

            headerNavButtons.forEach(button => {
                if (button.id === 'desktopCreateButton') return; 

                button.addEventListener('click', async function() {
                    headerNavButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    const navAction = this.dataset.nav;
                    currentSearchQuery = ''; 
                    currentView = navAction; // Update current view

                    if (desktopSearchHistoryContainer) desktopSearchHistoryContainer.style.display = 'none'; // Null check
                    if (searchSuggestionsListDesktop) searchSuggestionsListDesktop.style.display = 'none'; // Null check
                    if (mainElement) mainElement.classList.remove('desktop-search-active'); // Null check

                    if (pinGrid) pinGrid.style.display = 'column'; // Null check

                    // Show/hide categories based on view
                    if (navAction === 'home') {
                        if (desktopCategoriesSection) desktopCategoriesSection.style.display = 'block'; // Null check
                    } else {
                        if (desktopCategoriesSection) desktopCategoriesSection.style.display = 'none'; // Null check
                    }

                    loadedPinsCount = 0;
                    await loadPins(pinsPerPage, false);
                });
            });

            const searchOverlay = document.getElementById('searchOverlay');
            const closeSearchBtn = document.getElementById('closeSearchOverlay');
            
            const openSearch = () => {
                if (searchOverlay) searchOverlay.style.display = 'flex'; // Null check
                document.body.classList.add('no-scroll');
                if (mobileSearchInputOverlay) mobileSearchInputOverlay.value = ''; // Null check
                if (searchSuggestionsListMobile) searchSuggestionsListMobile.innerHTML = ''; // Null check
                if (searchSuggestionsListMobile) searchSuggestionsListMobile.style.display = 'none'; // Null check
                if (categoryExploreTitle) categoryExploreTitle.style.display = 'block'; // Null check
                if (categoryGridMobile) categoryGridMobile.style.display = 'grid'; // Null check
                renderSearchHistory(); 
            };
            
            const closeSearch = () => {
                if (searchOverlay) searchOverlay.style.display = 'none'; // Null check
                document.body.classList.remove('no-scroll');
            };

            if (closeSearchBtn) closeSearchBtn.onclick = closeSearch; // Null check
            
            const mobileNavItems = document.querySelectorAll('.mobile-bottom-nav .mobile-nav-item');
            mobileNavItems.forEach(item => {
                item.addEventListener('click', async function() {
                    const action = this.dataset.action;

                    window.closePinDetail();
                    closeNotificationPage();
                    closeSearch(); 
                    window.closeFullImageOverlay();
                    
                    if (action === 'search') {
                        openSearch();
                    } else if (action === 'create-pin') { 
                         if (!currentUser) {
                            window.location.href = 'login.html';
                            return;
                        } else if (!['Naughty', 'Sinful'].includes(currentUser.level)) { // NEW: Check user level for upload permission
                            showMessage('Anda tidak memiliki izin untuk membuat pin. Hanya pengguna Naughty dan Sinful yang diizinkan.', 'error');
                            return;
                        }
                        window.location.href = 'create.html'; 
                    }
                    else if (action === 'profile') { 
                        if (!currentUser) {
                            window.location.href = 'login.html';
                            return;
                        }
                        if (currentUser.isAdmin) {
                            window.location.href = 'admin.php';
                        } else {
                            window.location.href = 'user.php';
                        }
                    }
                    else { 
                        mobileNavItems.forEach(i => i.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Sync header nav buttons with mobile nav
                        const desktopButton = document.querySelector(`.header-nav-links .nav-button[data-nav="${action}"]`);
                        if (desktopButton) {
                            headerNavButtons.forEach(btn => btn.classList.remove('active'));
                            desktopButton.classList.add('active');
                        }

                        currentSearchQuery = ''; 
                        currentView = action; // Update current view

                        if (mainElement) mainElement.classList.remove('desktop-search-active'); // Null check
                        if (pinGrid) pinGrid.style.display = 'column'; // Null check

                        // Show/hide categories based on view
                        if (action === 'home') {
                            if (desktopCategoriesSection) desktopCategoriesSection.style.display = 'block'; // Null check
                        } else {
                            if (desktopCategoriesSection) desktopCategoriesSection.style.display = 'none'; // Null check
                        }

                        loadedPinsCount = 0;
                        await loadPins(pinsPerPage, false);
                    }
                });
            });

            const profileButton = document.getElementById('profileButton');
            const profileIconLetter = document.getElementById('profileIconLetter');

            profileButton.addEventListener('click', () => {
                if (!currentUser) {
                    window.location.href = 'login.html'; 
                } else {
                    if (currentUser.isAdmin) {
                        window.location.href = 'admin.php';
                    } else {
                        window.location.href = 'user.php';
                    }
                }
            });

            function updateProfileDisplay() {
                const mobileProfileIcon = document.querySelector('.mobile-nav-item[data-action="profile"] .profile-icon');
                if (currentUser) {
                    // Check if a profile image URL exists
                    if (currentUser.profile_image_url) {
                        profileIconLetter.style.backgroundImage = `url('${currentUser.profile_image_url}')`;
                        profileIconLetter.style.backgroundSize = 'cover';
                        profileIconLetter.style.backgroundPosition = 'center';
                        profileIconLetter.textContent = ''; // Hide the letter when an image is present
                        profileIconLetter.style.backgroundColor = 'transparent'; // Remove background color
                        profileIconLetter.style.color = 'transparent'; // Hide text color

                        if (mobileProfileIcon) {
                            mobileProfileIcon.style.backgroundImage = `url('${currentUser.profile_image_url}')`;
                            mobileProfileIcon.style.backgroundSize = 'cover';
                            mobileProfileIcon.style.backgroundPosition = 'center';
                            mobileProfileIcon.textContent = ''; // Hide the letter
                            mobileProfileIcon.style.backgroundColor = 'transparent'; // Remove background color
                            mobileProfileIcon.style.color = 'transparent'; // Hide text color
                        }
                    } else {
                        // Fallback to initial letter if no profile image URL
                        profileIconLetter.textContent = currentUser.username.charAt(0).toUpperCase();
                        profileIconLetter.style.backgroundColor = '#e60023';
                        profileIconLetter.style.color = 'white';
                        profileIconLetter.style.backgroundImage = 'none'; // Clear any previous image
                    }
                } else {
                    // Default guest display
                    profileIconLetter.textContent = 'G';
                    profileIconLetter.style.backgroundColor = '#ddd';
                    profileIconLetter.style.color = '#767676';
                    profileIconLetter.style.backgroundImage = 'none'; // Clear any previous image

                    if (mobileProfileIcon) {
                        mobileProfileIcon.textContent = 'G';
                        mobileProfileIcon.style.backgroundColor = '#e0e0e0';
                        mobileProfileIcon.style.color = '#333';
                        mobileProfileIcon.style.backgroundImage = 'none'; // Clear any previous image
                    }
                }
            }

            const notificationButton = document.getElementById('notificationButton');
            const mobileNotificationButton = document.getElementById('mobileNotificationButton');
            const notificationBadge = document.getElementById('notificationBadge');
            const mobileNotificationBadge = document.getElementById('mobileNotificationBadge');

            async function updateNotificationBadge() {
                try {
                    const response = await makeApiRequest('notifications.php?action=fetch_all');
                    if (response.success) {
                        const notifications = response.notifications || [];
                        const unreadCount = notifications.filter(notif => !notif.read).length; 
                        
                        if (unreadCount > 0) {
                            if (notificationBadge) notificationBadge.textContent = unreadCount; // Null check
                            if (notificationBadge) notificationBadge.style.display = 'flex'; // Null check
                            if (mobileNotificationBadge) mobileNotificationBadge.textContent = unreadCount; // Null check
                            if (mobileNotificationBadge) mobileNotificationBadge.style.display = 'flex'; // Null check
                        } else {
                            if (notificationBadge) notificationBadge.style.display = 'none'; // Null check
                            if (mobileNotificationBadge) mobileNotificationBadge.style.display = 'none'; // Null check
                        }
                    }
                } catch (error) {
                    console.error('Gagal memperbarui lencana notifikasi:', error);
                }
            }

            async function markAllNotificationsAsRead() {
                try {
                    const response = await makeApiRequest('notifications.php?action=mark_as_read', 'POST', null); 
                    if (response) {
                        if (!response.success) {
                            console.error('Gagal menandai notifikasi sebagai sudah dibaca:', response.message);
                        }
                        updateNotificationBadge();
                    }
                }
                catch (error) {
                    console.error('Gagal menandai notifikasi sebagai sudah dibaca:', error);
                }
            }

            if (notificationButton) notificationButton.addEventListener('click', openNotificationPage); // Null check
            if (mobileNotificationButton) mobileNotificationButton.addEventListener('click', openNotificationPage); // Null check

            window.downloadPin = function(imageUrl) {
                const link = document.createElement('a');
                link.href = imageUrl;
                const filename = imageUrl.substring(imageUrl.lastIndexOf('/') + 1) || 'pin_image.jpg';
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showMessage(`Mengunduh pin.`);
            };

            const moreAccountsButton = document.getElementById('moreAccountsButton');
            const moreAccountsDropdown = document.getElementById('moreAccountsDropdown');
            const dropdownUsernameDisplay = document.getElementById('dropdownUsernameDisplay');
            const dropdownMyProfile = document.getElementById('dropdownMyProfile');
            const dropdownAdminPanel = document.getElementById('dropdownAdminPanel');
            const dropdownLogout = document.getElementById('dropdownLogout');

            function toggleDropdown() {
                updateHeaderDropdown();
                if (moreAccountsDropdown) moreAccountsDropdown.style.display = moreAccountsDropdown.style.display === 'block' ? 'none' : 'block'; // Null check
            }

            function updateHeaderDropdown() {
                if (currentUser) {
                    if (dropdownUsernameDisplay) dropdownUsernameDisplay.textContent = `Masuk sebagai ${currentUser.username}`; // Null check
                    if (dropdownMyProfile) dropdownMyProfile.style.display = 'block'; // Null check
                    if (dropdownAdminPanel) dropdownAdminPanel.style.display = currentUser.isAdmin ? 'block' : 'none'; // Null check
                    if (dropdownLogout) dropdownLogout.style.display = 'block'; // Null check
                } else {
                    if (dropdownUsernameDisplay) dropdownUsernameDisplay.textContent = 'Selamat datang, Tamu!'; // Null check
                    if (dropdownMyProfile) dropdownMyProfile.style.display = 'none'; // Null check
                    if (dropdownAdminPanel) dropdownAdminPanel.style.display = 'none'; // Null check
                    if (dropdownLogout) dropdownLogout.style.display = 'none'; // Null check
                }
            }

            if (moreAccountsButton) moreAccountsButton.addEventListener('click', toggleDropdown); // Null check

            document.addEventListener('click', function(event) {
                if (moreAccountsButton && moreAccountsDropdown && !moreAccountsButton.contains(event.target) && !moreAccountsDropdown.contains(event.target)) {
                    moreAccountsDropdown.style.display = 'none';
                }
            });

            if (dropdownMyProfile) dropdownMyProfile.addEventListener('click', () => { // Null check
                if (currentUser) {
                    window.location.href = 'user.php';
                }
                if (moreAccountsDropdown) moreAccountsDropdown.style.display = 'none'; // Null check
            });

            if (dropdownAdminPanel) dropdownAdminPanel.addEventListener('click', () => { // Null check
                if (currentUser && currentUser.isAdmin) {
                    window.location.href = 'admin.php';
                } else {
                    showMessage('Akses ditolak: Diperlukan hak administrator.', 'Error');
                }
                if (moreAccountsDropdown) moreAccountsDropdown.style.display = 'none'; // Null check
            });

            if (dropdownLogout) dropdownLogout.addEventListener('click', async () => { // Null check
                const response = await makeApiRequest('auth.php?action=logout', 'POST', null); 
                if (response.success) {
                    currentUser = null;
                    updateProfileDisplay();
                    updateHeaderDropdown();
                    showMessage('Logout berhasil.', 'Logout');
                    loadedPinsCount = 0;
                    currentSearchQuery = ''; 
                    currentView = 'home';
                    if (desktopCategoriesSection) desktopCategoriesSection.style.display = 'block'; // Null check
                    await loadPins(pinsPerPage, false);
                    mobileNavItems.forEach(i => i.classList.remove('active'));
                    const homeMobileNav = document.querySelector('.mobile-nav-item[data-action="home"]');
                    if (homeMobileNav) homeMobileNav.classList.add('active'); // Null check
                    headerNavButtons.forEach(btn => btn.classList.remove('active'));
                    const homeDesktopNav = document.querySelector('.nav-button[data-nav="home"]');
                    if (homeDesktopNav) homeDesktopNav.classList.add('active'); // Null check
                } else {
                    showMessage('Logout gagal: ' + response.message, 'Error');
                }
                if (moreAccountsDropdown) moreAccountsDropdown.style.display = 'none'; // Null check
            });

            // mobileProfileDropdown dihapus, jadi tidak ada lagi variabel dan fungsi terkait di sini
            // mobileDropdownUsernameDisplay, mobileDropdownMyProfile, mobileDropdownAdminPanel, mobileDropdownLogout, mobileDropdownClose juga dihapus

            // Perbarui event listener untuk mobile profile button
            const mobileProfileNavItem = document.querySelector('.mobile-nav-item[data-action="profile"]');
            if (mobileProfileNavItem) { // Null check
                mobileProfileNavItem.addEventListener('click', () => {
                    if (!currentUser) {
                        window.location.href = 'login.html';
                        return;
                    }
                    if (currentUser.isAdmin) {
                        window.location.href = 'admin.php';
                    } else {
                        window.location.href = 'user.php';
                    }
                });
            }

            async function initializeApp() {
                loadSearchHistory(); 
                const urlParams = new URLSearchParams(window.location.search);

                const response = await makeApiRequest('auth.php?action=check_session');
                if (response.success && response.user) {
                    currentUser = response.user;
                    // NEW: Check if user needs username completion
                    if (currentUser.needs_username_completion) {
                        window.location.href = 'select_preferences.html?needs_username=true';
                        return; // Stop further initialization
                    }

                    if (typeof currentUser.canUpload === 'undefined') {
                        currentUser.canUpload = false; 
                    }
                    const savedResponse = await makeApiRequest(`pins.php?action=fetch_saved&username=${currentUser.username}`);
                    if (savedResponse.success) {
                        currentUser.savedPins = savedResponse.pins.map(pin => pin.id);
                    } else {
                        currentUser.savedPins = [];
                    }
                    // Fetch user preferences after successful login check
                    const userPrefResponse = await makeApiRequest('auth.php?action=get_user_preferences&username=' + currentUser.username);
                    if (userPrefResponse.success && userPrefResponse.preferences) {
                        currentUser.preferred_categories = userPrefResponse.preferences.preferred_categories || [];
                        currentUser.preferred_persons = userPrefResponse.preferences.preferred_persons || [];
                        currentUser.profile_image_url = userPrefResponse.preferences.profile_image_url || ''; // Get profile image URL
                        currentUser.liked_pins = userPrefResponse.preferences.liked_pins || []; // NEW: Ambil pin yang disukai pengguna
                    } else {
                        currentUser.preferred_categories = [];
                        currentUser.preferred_persons = [];
                        currentUser.profile_image_url = ''; // Ensure it's empty if not found
                        currentUser.liked_pins = []; // NEW: Pastikan kosong jika tidak ditemukan
                    }

                } else {
                    currentUser = null;
                }
                updateProfileDisplay();
                updateHeaderDropdown();
                updateNotificationBadge();
                
                // Fetch all pins initially for general use (search, personalization base)
                const allPinsResponse = await makeApiRequest('pins.php?action=fetch_all');
                if (allPinsResponse.success) {
                    allPinsData = allPinsResponse.pins; 
                } else {
                    console.error("Gagal memuat semua pin saat inisialisasi:", allPinsResponse.message);
                }

                if (currentUser) {
                    const savedPinsInitialResponse = await makeApiRequest(`pins.php?action=fetch_saved&username=${currentUser.username}`);
                    if (savedPinsInitialResponse.success) {
                        savedPinsData = savedPinsInitialResponse.pins;
                    } else {
                        console.error("Gagal memuat pin tersimpan saat inisialisasi:", savedPinsInitialResponse.message);
                    }
                }

                await loadPins(pinsPerPage, false);

                if (currentView === 'home') {
                    if (desktopCategoriesSection) desktopCategoriesSection.style.display = 'block'; // Null check
                } else {
                    if (desktopCategoriesSection) desktopCategoriesSection.style.display = 'none'; // Null check
                }

                const pinIdFromUrl = urlParams.get('pin');
                if (pinIdFromUrl) {
                    const pinToOpen = (allPinsData || []).find(pin => pin.id === pinIdFromUrl) || (savedPinsData || []).find(pin => pin.id === pinIdFromUrl);
                    if (pinToOpen) {
                        // Re-check permission before opening from URL history
                        if (pinToOpen.can_view_clearly) {
                            openPinDetail(pinToOpen);
                        } else {
                            // If not allowed to view clearly, close detail and remove pin param from URL
                            window.closePinDetail();
                            const currentUrl = new URL(window.location.href);
                            currentUrl.searchParams.delete('pin');
                            history.replaceState(null, '', currentUrl.toString());
                            window.location.href = '/Spicette/chat'; // Redirect to chat
                        }
                    } else {
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.delete('pin');
                        history.replaceState(null, '', currentUrl.toString());
                    }
                }
            }

            initializeApp();
        });
    </script>
</body>
</html>
